<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli | BAKÄ° S2 - ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --purple: #6c5ce7; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #110915; 
            color: #ffffff;
            min-height: 100vh;
            display: flex; 
        }
        .sidebar {
            background-color: #1a0e21; 
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
            width: 250px;
        }
        .main-content {
            background-color: #110915;
            flex-grow: 1;
        }
        .admin-card {
            background-color: #1a0e21;
            border: 1px solid rgba(108, 92, 231, 0.3);
            border-radius: 0.75rem; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); 
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            text-decoration: none;
            color: #e5e7eb;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .nav-item.active {
            background-color: var(--purple);
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.5);
        }
        .nav-item:hover:not(.active) {
            background-color: rgba(108, 92, 231, 0.1);
            border-radius: 0.5rem;
        }
        #loadingOverlay {
            background-color: #110915; 
            z-index: 1000; 
            display: flex; 
        }
        .admin-table th, .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #2a1b3a;
            text-align: left;
        }
        .log-line { font-family: monospace; font-size: 0.85rem; padding: 0.25rem 0; border-bottom: 1px dotted #2a1b3a; }
    </style>
</head>
<body class="flex">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            const adminPanelWrapper = document.getElementById('adminPanelWrapper');
            if (adminPanelWrapper) {
                adminPanelWrapper.classList.remove('hidden');
            }
        });
    </script>
    
    <div id="loadingOverlay" class="fixed inset-0 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mb-4"></div>
        <p id="loadingMessage" class="text-lg text-white text-center">YÃ¶netici Paneli yÃ¼kleniyor...</p>
    </div>

    <div id="adminPanelWrapper" class="hidden w-full flex">
        
        <div class="sidebar h-screen p-4 flex flex-col">
            <div class="text-3xl font-extrabold text-white mb-8 text-center">
                <i class="fas fa-screwdriver-wrench text-purple-500 mr-1"></i> ULTIMATE
            </div>

            <nav class="flex-grow space-y-2">
                <a href="#" class="nav-item active" data-content="dashboard">
                    <i class="fas fa-chart-line w-6 mr-3"></i> YÃ¶netim Panosu
                </a>
                <a href="#" class="nav-item" data-content="analytics">
                    <i class="fas fa-chart-bar w-6 mr-3"></i> Analizler
                </a>
                <a href="#" class="nav-item" data-content="network">
                    <i class="fas fa-satellite-dish w-6 mr-3"></i> AÄŸ Aktivitesi
                </a>
                <a href="#" class="nav-item" data-content="users">
                    <i class="fas fa-users w-6 mr-3"></i> KullanÄ±cÄ± YÃ¶netimi
                </a>
                <a href="#" class="nav-item" data-content="links">
                    <i class="fas fa-link w-6 mr-3"></i> Link YÃ¶netimi
                </a>
                 <a href="#" class="nav-item" data-content="reports">
                    <i class="fas fa-flag w-6 mr-3"></i> Rapor YÃ¶netimi
                </a>
                <a href="#" class="nav-item" data-content="settings">
                    <i class="fas fa-cogs w-6 mr-3"></i> Sistem AyarlarÄ±
                </a>
            </nav>

            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="adminLogoutButton" style="display: none;" class="w-full flex items-center justify-center p-3 text-red-400 bg-gray-700 rounded-lg font-semibold hover:bg-red-800 hover:text-white transition duration-200">
                    <i class="fas fa-sign-out-alt mr-3"></i> Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </div>

        <div class="main-content p-8 overflow-y-auto">
            <header class="mb-8 pb-4 border-b border-gray-700">
                <h1 id="pageTitle" class="text-4xl font-extrabold text-white">YÃ¶netim Panosu</h1>
                <p class="text-gray-400">Sistem verilerine hÄ±zlÄ± genel bakÄ±ÅŸ.</p>
            </header>

            <div id="dashboardContent" class="content-tab">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="admin-card p-6">
                        <i class="fas fa-users text-purple-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="totalUsers">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Toplam KullanÄ±cÄ±</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-link text-yellow-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="totalLinks">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Toplam Link</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-check-circle text-green-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="premiumUsers">YÃ¼kleniyor...</h4>
                        <p class="text-gray-400">Aktif Premium</p>
                    </div>
                    <div class="admin-card p-6">
                        <i class="fas fa-rocket text-red-400 text-3xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-white" id="linkClicks">58,741</h4>
                        <p class="text-gray-400">Toplam TÄ±klama (Vars.)</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Sistem SaÄŸlÄ±ÄŸÄ±</h3>
                        <div class="space-y-2">
                             <p class="text-gray-400 flex justify-between">Firestore Durumu: <span class="text-green-500">âœ… BaÄŸlÄ±</span></p>
                             <p class="text-gray-400 flex justify-between">Cloud Functions: <span class="text-yellow-500">âš ï¸ Gecikmeli</span></p>
                             <p class="text-gray-400 flex justify-between">CDN Ã–n belleÄŸi: <span class="text-green-500">âœ… Ã‡alÄ±ÅŸÄ±yor</span></p>
                        </div>
                    </div>
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Bekleyen Ä°ÅŸlemler</h3>
                        <div class="space-y-2">
                             <p class="text-gray-400 flex justify-between">Ä°ncelenmeyi bekleyen Rapor: <span class="text-yellow-400 font-bold">3</span></p>
                             <p class="text-gray-400 flex justify-between">Onay bekleyen Ã–deme: <span class="text-green-400 font-bold">1</span></p>
                             <p class="text-gray-400 flex justify-between">KullanÄ±cÄ±dan Gelen Mesaj: <span class="text-purple-400 font-bold">7</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analyticsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Analizler ve Ä°statistikler <i class="fas fa-chart-bar ml-2 text-blue-400"></i></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">Son 30 GÃ¼nlÃ¼k KayÄ±tlar</h4>
                        <canvas id="userChart"></canvas>
                    </div>
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">En Ã‡ok YÃ¶nlendiren Ãœlkeler</h4>
                        <canvas id="countryChart"></canvas>
                    </div>
                </div>
                <div class="admin-card p-6 mt-6">
                    <h4 class="text-xl font-bold text-white mb-4">En Ã‡ok TÄ±klanan Ä°lk 10 Link</h4>
                    <table class="admin-table w-full text-left">
                        <thead>
                            <tr>
                                <th class="text-purple-400">KÄ±sa URL</th>
                                <th class="text-purple-400">Hedef URL</th>
                                <th class="text-purple-400">TÄ±klama</th>
                            </tr>
                        </thead>
                        <tbody id="topLinksTableBody">
                            <tr><td>/deneme1</td><td>https://google.com/...</td><td>1250</td></tr>
                            <tr><td>/kampanya</td><td>https://example.com/prom...</td><td>890</td></tr>
                            <tr><td>/hizli-link</td><td>https://site.net/...</td><td>540</td></tr>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="networkContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">AÄŸ Aktivitesi ve CanlÄ± Loglar <i class="fas fa-satellite-dish ml-2 text-red-400"></i></h3>
                <p class="text-gray-300 mb-6">Sunucu isteklerini ve yÃ¶nlendirme trafiÄŸini izleyin.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">ğŸŒ KÃ¼resel Trafik HaritasÄ± (VarsayÄ±msal)</h4>
                        <div class="h-48 flex items-center justify-center bg-gray-900 rounded-lg border border-purple-500/30">
                            <span class="text-lg text-gray-500">ğŸŒ [KÃ¼resel Harita GÃ¶rÃ¼nÃ¼mÃ¼ API Entegrasyonu]</span>
                        </div>
                    </div>
                    <div class="admin-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">âš¡ CanlÄ± EriÅŸim LoglarÄ± (Son 10)</h4>
                        <div id="liveLogs" class="h-48 overflow-y-scroll bg-gray-900 rounded-lg p-2 border border-yellow-500/30 space-y-1">
                            <div class="log-line text-green-400">[12:21:45] GET /kisa-link-32: 200 OK (TR)</div>
                            <div class="log-line text-red-400">[12:21:40] ERROR: Invalid shortcode /bad-code: 404 (US)</div>
                            <div class="log-line text-green-400">[12:21:35] GET /kampanya: 200 OK (DE)</div>
                            <div class="log-line text-yellow-400">[12:21:30] WARN: User 12345 rate limit hit.</div>
                            </div>
                    </div>
                </div>
            </div>

            <div id="usersContent" class="content-tab hidden">
                 <h3 class="text-2xl font-bold text-white mb-4">KullanÄ±cÄ± YÃ¶netimi <i class="fas fa-user-shield ml-2 text-purple-400"></i></h3>
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ” KullanÄ±cÄ± Arama & Ä°ÅŸlemler</h4>
                    <div class="flex space-x-3 mb-4">
                        <input type="email" id="userSearchEmail" placeholder="KullanÄ±cÄ± E-posta Adresi..." class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                        <button id="searchUserButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg">Ara</button>
                    </div>
                    <div id="userSearchResult" class="mt-4 text-gray-300">Arama sonuÃ§larÄ± burada gÃ¶sterilecek.</div>

                    <div id="moderationControls" class="mt-6 pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h5 class="text-lg font-semibold text-white">SeÃ§ili KullanÄ±cÄ±ya Uygulanacak Eylemler</h5>
                         <select id="accountTypeSelect" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                            <option value="BASIC">TEMEL Hesap</option>
                            <option value="PREMIUM">PREMIUM Hesap</option>
                            <option value="ADMIN">YÃ–NETÄ°CÄ° Hesap</option>
                        </select>
                        <button id="updateAccountTypeButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-check mr-2"></i> Hesap Tipini GÃ¼ncelle
                        </button>
                        <button id="resetPasswordButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-key mr-2"></i> Åifre SÄ±fÄ±rlama Maili GÃ¶nder
                        </button>
                        <button id="banUserButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i class="fas fa-ban mr-2"></i> HesabÄ± KalÄ±cÄ± AskÄ±ya Al
                        </button>
                        <p class="text-sm text-yellow-400 mt-2">Bu eylemler iÃ§in Cloud Functions/Admin SDK gereklidir.</p>
                    </div>
                </div>
            </div>

            <div id="linksContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Link YÃ¶netimi <i class="fas fa-clipboard-list ml-2 text-yellow-400"></i></h3>
                
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ› ï¸ Link Arama ve Filtreleme</h4>
                     <div class="flex space-x-3 mb-4">
                        <input type="text" id="linkFilter" placeholder="Link (kÄ±sa/hedef) veya KullanÄ±cÄ± E-posta..." class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                        <select id="linkStatusFilter" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                            <option value="all">TÃ¼m Durumlar</option>
                            <option value="active">Aktif</option>
                            <option value="frozen">DondurulmuÅŸ</option>
                            <option value="reported">Raporlu</option>
                        </select>
                         <button id="filterLinksButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg">Filtrele</button>
                    </div>

                    <div id="linksListContainer" class="mt-4">
                        <table class="admin-table w-full text-left">
                            <thead>
                                <tr>
                                    <th class="text-yellow-400">KÄ±sa URL</th>
                                    <th class="text-yellow-400">TÄ±klama</th>
                                    <th class="text-yellow-400">OluÅŸturan</th>
                                    <th class="text-yellow-400">Durum</th>
                                    <th class="text-yellow-400">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="filteredLinksTableBody">
                                <tr><td>/link1</td><td>12</td><td>user1@mail.com</td><td>Aktif</td><td><button class="text-red-400 text-sm">Dondur</button></td></tr>
                                <tr><td>/link2</td><td>89</td><td>user2@mail.com</td><td>Raporlu</td><td><button class="text-red-400 text-sm">Sil</button></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card p-6">
                     <h4 class="text-xl font-bold mb-3">ğŸš¨ Toplu Ä°ÅŸlemler</h4>
                     <button id="bulkFreezeAllButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg mr-3">
                        <i class="fas fa-snowflake mr-2"></i> TÃ¼m Linkleri Dondur
                    </button>
                     <button id="bulkDeleteReportedButton" class="bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-5 rounded-lg">
                        <i class="fas fa-trash mr-2"></i> Raporlu Linkleri Toplu Sil
                    </button>
                </div>
            </div>

            <div id="reportsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Rapor ve Spam YÃ¶netimi <i class="fas fa-flag ml-2 text-pink-400"></i></h3>
                <p class="text-gray-300 mb-6">KullanÄ±cÄ± ÅŸikayetlerini inceleyin ve spam algÄ±lama sistemini yÃ¶netin.</p>

                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ“¥ Bekleyen KullanÄ±cÄ± RaporlarÄ± (Vars.)</h4>
                    <div id="pendingReportsList" class="space-y-3">
                        <div class="p-3 bg-gray-700 rounded-lg flex justify-between items-center">
                            <span>**Rapor ID: 001** - Link: /xyz123 (Neden: KÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±m)</span>
                            <div class="space-x-2">
                                <button class="text-green-400 hover:text-green-500 text-sm">Onayla (Link Sil)</button>
                                <button class="text-yellow-400 hover:text-yellow-500 text-sm">Reddet</button>
                            </div>
                        </div>
                        <p class="text-gray-400">Åu anda **3** rapor incelenmeyi bekliyor.</p>
                    </div>
                </div>

                <div class="admin-card p-6">
                    <h4 class="text-xl font-bold mb-3">ğŸš« Anahtar Kelime Kara Listesi</h4>
                    <p class="text-gray-400 mb-3">Link kÄ±saltma hedef URL'lerinde yasaklanacak kelimeler/domainler.</p>
                    <textarea rows="3" placeholder="Ã–rnek: phishing.com, spam-site.net, illegal-kelime" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white"></textarea>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg mt-3">Kara Listeyi Kaydet</button>
                </div>
            </div>

            <div id="settingsContent" class="content-tab hidden">
                <h3 class="text-2xl font-bold text-white mb-4">Sistem AyarlarÄ± <i class="fas fa-server ml-2 text-green-400"></i></h3>
                
                <div class="admin-card p-6 mb-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ‘· BakÄ±m Modu & Durum</h4>
                    <button id="maintenanceModeToggle" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg transition duration-200">
                        <i class="fas fa-toggle-off mr-2"></i> BakÄ±m Modunu AÃ§
                    </button>
                    <p id="maintenanceStatus" class="mt-3 text-sm text-green-400 hidden">Sistem bakÄ±m modunda.</p>
                </div>

                <div class="admin-card p-6 mb-6">
                     <h4 class="text-xl font-bold mb-3">ğŸ’° Premium Ã–deme Entegrasyonu</h4>
                     <label class="block mb-2 text-gray-400">Stripe/Iyzico API AnahtarÄ±:</label>
                     <input type="password" placeholder="sk_live_******************" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white mb-4">
                     <label class="flex items-center space-x-2 text-white">
                        <input type="checkbox" checked class="form-checkbox text-purple-600 bg-gray-700 border-gray-600 rounded">
                        <span>Otomatik Abonelik Yenilemeyi EtkinleÅŸtir</span>
                    </label>
                </div>
                
                <div class="admin-card p-6">
                    <h4 class="text-xl font-bold mb-3">ğŸ§¹ Ã–nbellek YÃ¶netimi</h4>
                    <p class="text-gray-400 mb-3">Sunucu ve CDN Ã¶nbelleÄŸini temizleyerek tÃ¼m deÄŸiÅŸikliklerin anÄ±nda yayÄ±lmasÄ±nÄ± saÄŸlayÄ±n.</p>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg mr-3">
                        <i class="fas fa-eraser mr-2"></i> CDN Ã–nbelleÄŸini Temizle
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase Config ve BaÅŸlatma
        const firebaseConfig = {
            apiKey: "AIzaSyBfc0F8o5aVmwTw-gyLRZVI2OMUljFi6Ao",
            authDomain: "baki-s2-yonetim.firebaseapp.com",
            projectId: "baki-s2-yonetim",
            storageBucket: "baki-s2-yonetim.firebasestorage.app",
            messagingSenderId: "692508919425",
            appId: "1:692508919425:web:fac963c81c11b7be70af80",
            measurementId: "G-Q52XG8GLB2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // HTML Elementleri
        const loadingMessage = document.getElementById('loadingMessage');
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const navItems = document.querySelectorAll('.nav-item');
        const contentTabs = document.querySelectorAll('.content-tab');
        const pageTitle = document.getElementById('pageTitle');

        // YENÄ° ELEMANLAR
        const searchUserButton = document.getElementById('searchUserButton');
        const userSearchEmail = document.getElementById('userSearchEmail');
        const userSearchResult = document.getElementById('userSearchResult');
        const moderationControls = document.getElementById('moderationControls');
        const maintenanceModeToggle = document.getElementById('maintenanceModeToggle');
        const maintenanceStatus = document.getElementById('maintenanceStatus');

        // Chart deÄŸiÅŸkenleri
        let userChartInstance = null;
        let countryChartInstance = null;
        
        // --- KullanÄ±cÄ± ArayÃ¼zÃ¼ GÃ¼ncellemesi (Firebase durumuna gÃ¶re) ---
        function updateAdminUI(user) {
            if (user) {
                adminLogoutButton.style.display = 'flex'; 
                loadingMessage.textContent = `Oturum aÃ§Ä±k: ${user.email}. Veriler yÃ¼kleniyor...`;
            } else {
                adminLogoutButton.style.display = 'none';
                loadingMessage.textContent = 'GiriÅŸ yapÄ±lmadan eriÅŸildi. Sadece admin bilir.';
            }
        }

        // --- Veri Ã‡ekme Fonksiyonu (YÃ¶netim Panosu) ---
        async function loadDashboardData() {
            try {
                // Not: GÃ¼venlik KurallarÄ± Ä°hlali nedeniyle HATA almanÄ±z olasÄ±dÄ±r.
                const usersSnapshot = await getDocs(collection(db, "users"));
                document.getElementById('totalUsers').textContent = usersSnapshot.size.toLocaleString('tr-TR');

                const linksSnapshot = await getDocs(collection(db, "links"));
                document.getElementById('totalLinks').textContent = linksSnapshot.size.toLocaleString('tr-TR');

                const premiumQuery = query(collection(db, "users"), where("accountType", "==", "PREMIUM"));
                const premiumSnapshot = await getDocs(premiumQuery);
                document.getElementById('premiumUsers').textContent = premiumSnapshot.size.toLocaleString('tr-TR');

            } catch (e) {
                console.error("YÃ¶netim verileri yÃ¼klenirken hata (GÃ¼venlik KuralÄ± Ä°hlali OlasÄ±):", e);
                // Hata durumunda varsayÄ±lan/sabit deÄŸer gÃ¶ster
                document.getElementById('totalUsers').textContent = '2,540 (HATA)';
                document.getElementById('totalLinks').textContent = '15,870 (HATA)';
                document.getElementById('premiumUsers').textContent = '120 (HATA)';
            }
        }
        
        // --- YENÄ° Ã–ZELLÄ°K: Analiz GrafiÄŸi Ã‡izme (VarsayÄ±msal Veri) ---
        function drawAnalyticsCharts() {
            if (userChartInstance) userChartInstance.destroy();
            if (countryChartInstance) countryChartInstance.destroy();
            
            const days = Array.from({length: 7}, (_, i) => new Date(Date.now() - (7 - i) * 24 * 60 * 60 * 1000).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }));
            const userCounts = [15, 22, 18, 25, 30, 45, 35];
            const countryData = { 'TÃ¼rkiye': 4500, 'Almanya': 2500, 'ABD': 1500, 'DiÄŸer': 1500 };

            // KullanÄ±cÄ± GrafiÄŸi
            const userCtx = document.getElementById('userChart').getContext('2d');
            userChartInstance = new Chart(userCtx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Yeni KullanÄ±cÄ±lar',
                        data: userCounts,
                        backgroundColor: '#6c5ce7',
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'white' } }, x: { grid: { display: false }, ticks: { color: 'white' } } } }
            });

            // Ãœlke GrafiÄŸi (Doughnut)
            const countryCtx = document.getElementById('countryChart').getContext('2d');
            countryChartInstance = new Chart(countryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(countryData),
                    datasets: [{
                        data: Object.values(countryData),
                        backgroundColor: ['#6c5ce7', '#ffc107', '#20c997', '#e5e7eb'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: 'white' } } }
                }
            });
        }

        // --- KullanÄ±cÄ± Arama Ä°ÅŸlevi ---
        searchUserButton.addEventListener('click', async () => {
            const email = userSearchEmail.value.trim();
            userSearchResult.innerHTML = 'KullanÄ±cÄ± aranÄ±yor...';
            moderationControls.classList.add('hidden'); 

            if (!email) {
                userSearchResult.innerHTML = '<span class="text-red-400">LÃ¼tfen bir e-posta adresi girin.</span>';
                return;
            }

            try {
                // Auth ve Firestore kontrolÃ¼
                const methods = await fetchSignInMethodsForEmail(auth, email);

                if (methods && methods.length > 0) {
                    const userQuery = query(collection(db, "users"), where("email", "==", email), limit(1));
                    const userSnap = await getDocs(userQuery);

                    if (!userSnap.empty) {
                        const userData = userSnap.docs[0].data();
                        
                        userSearchResult.innerHTML = `
                            <div class="mt-4 p-4 border border-green-500 rounded-lg bg-gray-800">
                                <h5 class="font-bold text-green-400">KullanÄ±cÄ± Bulundu: ${email}</h5>
                                <p>Hesap Tipi: <span class="font-semibold">${userData.accountType || 'TEMEL'}</span></p>
                                <p>UID: ${userSnap.docs[0].id}</p>
                            </div>
                        `;
                        moderationControls.classList.remove('hidden');

                    } else {
                        userSearchResult.innerHTML = `<span class="text-yellow-400">Auth'da var, ancak Firestore kaydÄ± bulunamadÄ±.</span>`;
                    }
                } else {
                    userSearchResult.innerHTML = `<span class="text-red-400">Bu e-posta adresine kayÄ±tlÄ± bir kullanÄ±cÄ± bulunamadÄ±.</span>`;
                }

            } catch (error) {
                console.error("KullanÄ±cÄ± arama hatasÄ±:", error);
                userSearchResult.innerHTML = `<span class="text-red-400">Hata oluÅŸtu: ${error.message}</span>`;
            }
        });
        
        // --- Sayfa GeÃ§iÅŸleri (Tab Switching) ---
        const switchTab = (targetContentId) => {
            contentTabs.forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${targetContentId}Content`).classList.remove('hidden');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-content') === targetContentId) {
                    item.classList.add('active');
                }
            });
            
            const titleMap = {
                'dashboard': 'YÃ¶netim Panosu',
                'analytics': 'Sistem Analizleri',
                'network': 'AÄŸ Aktivitesi',
                'users': 'KullanÄ±cÄ± YÃ¶netimi',
                'links': 'Link YÃ¶netimi',
                'reports': 'Rapor YÃ¶netimi',
                'settings': 'Sistem AyarlarÄ±'
            };
            pageTitle.textContent = titleMap[targetContentId] || 'YÃ¶netim Paneli';

            if (targetContentId === 'analytics') {
                drawAnalyticsCharts();
            }
        };

        // --- Olay Dinleyicileri ---
        adminLogoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.reload(); 
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", error);
                alert("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu.");
            }
        });

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(item.getAttribute('data-content'));
            });
        });

        // BakÄ±m Modu Ä°ÅŸlevi
        maintenanceModeToggle.addEventListener('click', () => {
            const isActive = maintenanceModeToggle.classList.contains('bg-red-600');
            if (isActive) {
                maintenanceModeToggle.classList.replace('bg-red-600', 'bg-gray-500');
                maintenanceModeToggle.classList.replace('hover:bg-red-700', 'hover:bg-gray-600');
                maintenanceModeToggle.innerHTML = '<i class="fas fa-toggle-off mr-2"></i> BakÄ±m Modunu AÃ§';
                maintenanceStatus.classList.add('hidden');
            } else {
                maintenanceModeToggle.classList.replace('bg-gray-500', 'bg-red-600');
                maintenanceModeToggle.classList.replace('hover:bg-gray-600', 'hover:bg-red-700');
                maintenanceModeToggle.innerHTML = '<i class="fas fa-toggle-on mr-2"></i> BakÄ±m Modunu Kapat';
                maintenanceStatus.classList.remove('hidden');
                maintenanceStatus.textContent = 'UYARI: Sistem bakÄ±m modunda.';
                maintenanceStatus.classList.add('text-red-400');
            }
        });

        // --- BaÅŸlatma ---
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('dashboard'); 

            onAuthStateChanged(auth, (user) => {
                updateAdminUI(user);
            });
           
            loadDashboardData(); 
        });

    </script>
</body>
</html>
