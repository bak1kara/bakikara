r';
        
        switch (status) {
            case 'ACTIVE':
                className = 'status-active';
                text = 'YAYINDA';
                break;
            case 'PENDING':
                className = 'status-pending';
                text = 'Onay Bekliyor';
                break;
            case 'SUSPENDED':
                className = 'status-suspended';
                text = 'ASKIYA ALINDI';
                break;
            case 'PASSIVE':
                className = 'status-passive';
                text = 'PASÄ°F';
                break;
            case 'FILE_WAITING':
            default:
                className = 'status-file';
                text = 'Dosya Bekleniyor';
                break;
        }
        return `<span class="status-badge ${className}" data-status="${status}">${text}</span>`;
    }

    /**
     * MÃ¼ÅŸteri verilerini tabloya iÅŸleyen ana render fonksiyonu
     */
    function renderTable(customers) {
        // SÄ±ralama uygula
        customers.sort((a, b) => {
            let aVal = a[sortKey];
            let bVal = b[sortKey];

            // ğŸ”¥ DÃœZELTME: created_at kullanÄ±lÄ±yor
            if (sortKey === 'created_at') { 
                // Supabase'den gelen tarih string'ini Date nesnesine Ã§evir
                aVal = aVal ? new Date(aVal).getTime() : 0;
                bVal = bVal ? new Date(bVal).getTime() : 0;
            }
            if (sortKey === 'balance') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        tableBody.innerHTML = '';

        // SÄ±ralama ikonu gÃ¼ncelleme
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
        });
        // ğŸ”¥ DÃœZELTME: Sadece created_at'i ayrÄ± ele al
        let iconId = '';
        if (sortKey === 'created_at') {
            iconId = 'sortCreated_at';
        } else {
            iconId = `sort${sortKey.charAt(0).toUpperCase() + sortKey.slice(1)}`;
        }
        
        const currentSortIcon = document.getElementById(iconId);
        
        if (currentSortIcon) {
             currentSortIcon.classList.remove('fa-sort');
             currentSortIcon.classList.add(sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        }

        if (customers.length === 0) {
            // Tablo sÃ¼tun sayÄ±sÄ± 6 oldu (E-posta, Tarih, Bakiye, Adres, Durum, Ä°ÅŸlemler)
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--warning-color);">Filtreye uyan mÃ¼ÅŸteri bulunamadÄ±.</td></tr>`;
            return;
        }

        customers.forEach(user => {
            const userEmail = user.email || 'Bilinmiyor';
            const username = userEmail.split('@')[0];
            const siteUrl = `bakikara.xyz/${user.site_adi || username}`; // Site adÄ± varsa onu kullan
            // ğŸ”¥ DÃœZELTME: user.created_at kullanÄ±lÄ±yor
            const regDate = user.created_at ? new Date(user.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Bilinmiyor';
            const status = user.serviceStatus || 'FILE_WAITING'; 
            const balance = (user.balance || 0).toFixed(2); // Bakiye deÄŸeri

            const row = tableBody.insertRow();
            
            row.innerHTML = `
                <td data-label="E-posta / Site AdÄ±">
                    <strong>${userEmail}</strong><br>
                    <span style="color:var(--text-secondary);">${user.site_adi || 'Site AdÄ± Yok'}</span>
                </td>
                <td data-label="KayÄ±t Tarihi">${regDate}</td>
                <td data-label="Bakiye (â‚º)">â‚º ${balance}</td>
                <td data-label="Site Adresi (Ã–neri)"><a href="http://${siteUrl}" target="_blank" style="color:var(--info-color);">${siteUrl}</a></td>
                <td data-label="Durum">${getStatusBadge(status)}</td>
                <td data-label="Ä°ÅŸlemler">
                    <button class="action-btn detail-btn" onclick="window.showCustomerDetailModal('${user.user_id}')"><i class="fas fa-search"></i> Detay/DÃ¼zenle</button>
                    <button class="action-btn open-site-btn" onclick="window.openCustomerSite('${siteUrl}')"><i class="fas fa-external-link-alt"></i> Siteyi AÃ§</button>
                    <button class="action-btn" onclick="window.updateCustomerStatus('${user.user_id}', 'ACTIVE')"><i class="fas fa-check"></i> YayÄ±na Al</button>
                    <button class="action-btn delete-btn" onclick="window.deleteCustomer('${user.user_id}')"><i class="fas fa-trash-alt"></i> Sil</button>
                </td>
            `;
        });
    }

    /**
     * Tablo baÅŸlÄ±ÄŸÄ±na tÄ±klandÄ±ÄŸÄ±nda sÄ±ralama yapar
     */
    window.sortCustomers = function(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortKey = key;
            sortDirection = 'asc'; 
            // ğŸ”¥ DÃœZELTME: created_at kullanÄ±lÄ±yor
            if (key === 'created_at' || key === 'balance') sortDirection = 'desc'; 
        }
        filterCustomers(); // Veriyi yeniden render et
    }

    /**
     * Arama ve Durum Filtreleme Fonksiyonu
     */
    window.filterCustomers = function() {
        const searchText = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value; // Yeni filtre

        const filtered = allCustomers.filter(user => {
            const userEmail = (user.email || '').toLowerCase();
            const username = userEmail.split('@')[0].toLowerCase();
            const siteAdi = (user.site_adi || '').toLowerCase();
            const status = (user.serviceStatus || 'FILE_WAITING');
            
            // Metin aramasÄ± kontrolÃ¼
            const textMatch = userEmail.includes(searchText) || username.includes(searchText) || siteAdi.includes(searchText);
            
            // Durum filtresi kontrolÃ¼
            const statusMatch = statusFilter === 'ALL' || status === statusFilter;

            return textMatch && statusMatch;
        });

        renderTable(filtered);
    }

    // ----------------------------------------------------------------------
    // 3. GERÃ‡EK ZAMANLI VERÄ° Ã‡EKME (SUPABASE REALTIME)
    // ----------------------------------------------------------------------

    /**
     * Veriyi bir kez Ã§eken ana fonksiyon (Firestore'daki getDocs'a karÅŸÄ±lÄ±k gelir)
     */
    async function fetchAndRenderCustomers() {
        loading.style.display = 'block';

        try {
            // Supabase'den tÃ¼m mÃ¼ÅŸterileri Ã§ek
            const { data: customers, error } = await supabaseClient
                .from('customers') // OluÅŸturduÄŸumuz tablo adÄ±
                .select('*') 
                // ğŸ”¥ DÃœZELTME: created_at kullanÄ±lÄ±yor
                .order('created_at', { ascending: false }); 

            if (error) {
                throw error;
            }

            loading.style.display = 'none';
            table.style.display = 'table';
            
            if (!customers || customers.length === 0) {
                loading.innerText = 'HenÃ¼z kayÄ±tlÄ± mÃ¼ÅŸteri bulunmamaktadÄ±r.';
                loading.style.display = 'block';
                allCustomers = [];
                renderTable([]);
                
                totalCustomersSpan.innerText = '0';
                activeCustomersSpan.innerText = '0';
                pendingCustomersSpan.innerText = '0';
                return;
            }

            // user_id Firestore'da doc.id iken, Supabase'de tablo sÃ¼tun adÄ±mÄ±zdÄ±r
            allCustomers = customers.map(doc => ({
                userId: doc.user_id, // Firestore'daki userId yerine Supabase'deki user_id sÃ¼tunu
                ...doc
            }));

            // Ã–zet KartlarÄ± GÃ¼ncelle
            const activeCount = allCustomers.filter(u => u.serviceStatus === 'ACTIVE').length;
            const pendingCount = allCustomers.filter(u => u.serviceStatus === 'PENDING' || u.serviceStatus === 'FILE_WAITING').length; 
            
            totalCustomersSpan.innerText = allCustomers.length;
            activeCustomersSpan.innerText = activeCount;
            pendingCustomersSpan.innerText = pendingCount; 

            // Mevcut filtre ve sÄ±ralama ayarlarÄ±nÄ± kullanarak tabloyu yeniden Ã§iz
            filterCustomers();

        } catch (error) {
            console.error("Supabase Veri Ã‡ekme HatasÄ±:", error.message);
            loading.style.display = 'none';
            errorMessage.innerText = `Veri dinleme hatasÄ±: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }


    /**
     * MÃ¼ÅŸteri Verilerini GerÃ§ek ZamanlÄ± Dinleme ve Ã–zet KartlarÄ± GÃ¼ncelleme
     */
    function listenForCustomers() {
        loading.style.display = 'block';
        table.style.display = 'none';
        errorMessage.style.display = 'none';
        
        // Supabase Realtime Dinleyicisini BaÅŸlat
        const channel = supabaseClient
            .channel('customer_changes') 
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'customers' }, // customers tablosundaki her deÄŸiÅŸikliÄŸi dinle
                (payload) => {
                    console.log('GerÃ§ek ZamanlÄ± Veri DeÄŸiÅŸikliÄŸi AlgÄ±landÄ±:', payload);
                    // DeÄŸiÅŸiklik olduÄŸunda tÃ¼m listeyi yeniden Ã§ekip render et
                    fetchAndRenderCustomers();
                }
            )
            .subscribe(); 

        // Ä°lk veriyi Ã§ekme fonksiyonunu Ã§aÄŸÄ±r
        fetchAndRenderCustomers();

        return channel;
    };
    
    /**
     * En son yayÄ±nlanan duyurularÄ± (aktivite) Ã§eker ve dinler. (Åimdilik sadece Ã§eker)
     */
    async function listenForRecentActivity() {
        console.log("Aktivite dinleyicisi baÅŸlatÄ±ldÄ±...");
        
        try {
            // Supabase'den son 5 duyuruyu Ã§ek
            const { data: announcements, error } = await supabaseClient
                // ğŸ”¥ DÃœZELTME: created_at kullanÄ±lÄ±yor
                .from('announcements')
                .select('text, created_at') // Sadece metin ve oluÅŸturulma tarihi
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) throw error;
            
            announcementList.innerHTML = ''; 
            
            if (announcements.length === 0) {
                announcementList.innerHTML = `<li><i class="fas fa-info-circle"></i> HenÃ¼z yayÄ±nlanmÄ±ÅŸ bir duyuru yok.</li>`;
                return;
            }

            announcements.forEach(announcement => {
                // ğŸ”¥ DÃœZELTME: announcement.created_at kullanÄ±lÄ±yor
                const date = announcement.created_at ? new Date(announcement.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Bilinmiyor';
                
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="activity-text"><i class="fas fa-bell" style="color:var(--primary-color);"></i> ${announcement.text.substring(0, 70)}${announcement.text.length > 70 ? '...' : ''}</span>
                    <span class="activity-meta">${date}</span>
                `;
                announcementList.appendChild(listItem);
            });

        } catch (error) {
            console.error("Aktivite dinlenirken hata oluÅŸtu:", error);
            announcementList.innerHTML = `<li><i class="fas fa-exclamation-triangle" style="color:var(--danger-color);"></i> Aktivite yÃ¼klenirken hata oluÅŸtu.</li>`;
        }
    }

    // ----------------------------------------------------------------------
    // 4. DUYURU YÃ–NETÄ°MÄ° (SUPABASE INSERT)
    // ----------------------------------------------------------------------

    /**
     * Yeni Duyuru Ekleme Fonksiyonu
     */
    async function publishAnnouncement() {
        const textElement = document.getElementById('announcementText');
        const messageElement = document.getElementById('announcementMessage');
        const btn = document.getElementById('publishAnnouncementBtn');
        
        const announcementText = textElement.value.trim();

        if (announcementText.length < 5) {
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = 'Duyuru metni en az 5 karakter olmalÄ±dÄ±r.';
            return;
        }

        messageElement.innerText = 'YayÄ±nlanÄ±yor...';
        btn.disabled = true;

        try {
            // Supabase ile Duyuru Ekleme
            const { error } = await supabaseClient
                .from('announcements') // announcements tablosuna ekle
                .insert([
                    {
                        text: announcementText,
                        // createdAt alanÄ± Supabase'de otomatik eklenebilir
                        publishedBy: ADMIN_EMAIL 
                    }
                ]);

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = 'âœ… Duyuru baÅŸarÄ±yla yayÄ±nlandÄ±! (MÃ¼ÅŸteri sitelerinde gÃ¶rÃ¼necek)';
            textElement.value = ''; 
            
            // YayÄ±n baÅŸarÄ±lÄ± olduÄŸunda aktivite listesini gÃ¼ncelle
            listenForRecentActivity();

        } catch (error) {
            console.error("Duyuru yayÄ±nlanÄ±rken hata oluÅŸtu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Duyuru hatasÄ±: ${error.message}`;
        } finally {
            btn.disabled = false;
            setTimeout(() => messageElement.innerText = '', 5000); 
        }
    }
    
    // ----------------------------------------------------------------------
    // 5. MÃœÅTERÄ° Ä°ÅLEM FONKSÄ°YONLARI (SUPABASE UPDATE/DELETE)
    // ----------------------------------------------------------------------

    /**
     * MÃ¼ÅŸteri Durumunu GÃ¼ncelleme
     */
    window.updateCustomerStatus = function(userId, newStatus) {
        let statusText = '';
        if (newStatus === 'ACTIVE') statusText = 'YAYINA AL';
        else if (newStatus === 'SUSPENDED') statusText = 'ASKIYA AL';
        else statusText = newStatus;
        
        showModal(
            "Durum GÃ¼ncelleme",
            `KullanÄ±cÄ± ID: ${userId} durumunu ${statusText} olarak gÃ¼ncellemek istediÄŸinizden emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        // Supabase ile GÃ¼ncelleme
                        const { error } = await supabaseClient
                            // Supabase'in otomatik last_updated alanÄ±nÄ± kullanmak iÃ§in burada lastUpdated yerine last_updated kullanÄ±lmasÄ± gerekebilir.
                            .from('customers')
                            .update({ serviceStatus: newStatus, lastUpdated: new Date().toISOString() }) 
                            .eq('user_id', userId); // user_id'si eÅŸleÅŸeni bul

                        if (error) throw error;

                        showModal("BaÅŸarÄ±lÄ±", `Durum baÅŸarÄ±yla ${statusText} olarak gÃ¼ncellendi.`, 'alert');
                    } catch (error) {
                        console.error("Durum gÃ¼ncellenirken hata oluÅŸtu:", error);
                        showModal("Hata", "Durum gÃ¼ncellenirken bir hata oluÅŸtu: " + error.message, 'alert');
                    }
                }
            }
        );
    }

    /**
     * MÃ¼ÅŸteriyi Silme
     */
    window.deleteCustomer = function(userId) {
        showModal(
            "KalÄ±cÄ± Silme OnayÄ±",
            `DÄ°KKAT! KullanÄ±cÄ± ID: ${userId} kalÄ±cÄ± olarak silinecektir. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        // Supabase ile Silme
                        const { error } = await supabaseClient
                            .from('customers')
                            .delete()
                            .eq('user_id', userId); // user_id'si eÅŸleÅŸeni sil

                        if (error) throw error;
                            
                        showModal("BaÅŸarÄ±lÄ±", `KullanÄ±cÄ± baÅŸarÄ±yla silindi.`, 'alert');
                    } catch (error) {
                        console.error("KullanÄ±cÄ± silinirken hata oluÅŸtu:", error);
                        showModal("Hata", "KullanÄ±cÄ± silinirken bir hata oluÅŸtu: " + error.message, 'alert');
                    }
                }
            }
        );
    }
    
    /**
     * MÃ¼ÅŸterinin Sitesini AÃ§ma
     */
    window.openCustomerSite = function(siteUrl) {
        window.open(`http://${siteUrl}`, '_blank');
    }

    // ----------------------------------------------------------------------
    // 6. DETAY/DÃœZENLE MODALI Ä°ÅLEVLERÄ° (SUPABASE UPDATE)
    // ----------------------------------------------------------------------
    
    window.showCustomerDetailModal = function(userId) {
        // userId artÄ±k Firestore doc.id yerine Supabase'deki user_id sÃ¼tunudur
        const user = allCustomers.find(u => u.userId === userId); 
        if (!user) return;

        currentEditingUser = user;
        
        document.getElementById('detailEmail').value = user.email || '';
        document.getElementById('detailSiteName').value = user.site_adi || '';
        document.getElementById('detailBalance').value = (user.balance || 0); // Bakiye deÄŸeri
        document.getElementById('detailStatus').value = user.serviceStatus || 'FILE_WAITING';
        document.getElementById('detailNotes').value = user.admin_notes || '';
        document.getElementById('detailMessage').innerText = ''; 
        
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    window.saveCustomerDetails = async function() {
        if (!currentEditingUser) return;

        const btn = document.getElementById('saveDetailsBtn');
        const messageElement = document.getElementById('detailMessage');
        
        btn.disabled = true;
        messageElement.style.color = 'var(--info-color)';
        messageElement.innerText = 'Kaydediliyor...';

        try {
            // Bakiye alanÄ±nÄ± float olarak kaydetmek iÃ§in parse et
            const newBalance = parseFloat(document.getElementById('detailBalance').value) || 0; 
            
            // Supabase ile Toplu GÃ¼ncelleme
            const { error } = await supabaseClient
                .from('customers')
                .update({
                    site_adi: document.getElementById('detailSiteName').value.trim(),
                    serviceStatus: document.getElementById('detailStatus').value,
                    admin_notes: document.getElementById('detailNotes').value.trim(),
                    balance: newBalance,
                    lastUpdated: new Date().toISOString() // Supabase timestamp formatÄ± (EÄŸer tablonuzda bu isimde sÃ¼tun yoksa hata verebilir, ama ÅŸimdilik bÄ±rakÄ±yorum)
                })
                .eq('user_id', currentEditingUser.userId); // DoÄŸru user_id ile eÅŸleÅŸtir

            if (error) throw error;

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = 'âœ… Detaylar baÅŸarÄ±yla gÃ¼ncellendi!';
            
            setTimeout(() => {
                document.getElementById('detailModal').style.display = 'none';
                currentEditingUser = null;
            }, 1000);

        } catch (error) {
            console.error("Detaylar kaydedilirken hata oluÅŸtu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Hata: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }
    
    document.getElementById('closeDetailModalBtn').addEventListener('click', () => {
        document.getElementById('detailModal').style.display = 'none';
        currentEditingUser = null;
    });

    document.getElementById('saveDetailsBtn').addEventListener('click', saveCustomerDetails);

    // ----------------------------------------------------------------------
    // 7. YETKÄ°LENDÄ°RME ve BAÅLATMA (GEÃ‡Ä°CÄ° OLARAK GÃœVENSÄ°Z YÃ–NTEM)
    // ----------------------------------------------------------------------

    /**
     * Ã‡Ä±kÄ±ÅŸ Yapma Ä°ÅŸlemi (Åimdilik yÃ¶nlendirme yapar)
     */
    window.handleLogout = function() {
        showModal("GÃœVENSÄ°Z KULLANIM", "Åu anda yÃ¶netici yetkilendirme sistemi (Auth) devre dÄ±ÅŸÄ±dÄ±r. Ã‡Ä±kÄ±ÅŸ yapmak iÃ§in login.html sayfasÄ±na yÃ¶nlendiriliyorsunuz.", 'alert', () => {
             // Supabase Auth entegre edilene kadar yÃ¶nlendirme yapar
             window.location.href = 'login.html';
        });
    }

    // â›”ï¸ GÃ¼venlik UyarÄ±sÄ±: Firebase Auth kaldÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in, sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz veri Ã§ekme baÅŸlatÄ±lÄ±r.
    listenForCustomers();
    listenForRecentActivity(); // Aktivite loglarÄ±nÄ± baÅŸlat
    
    // Duyuru butonunu baÄŸla
    document.getElementById('publishAnnouncementBtn').addEventListener('click', publishAnnouncement);
</script>
</body>
</html>
