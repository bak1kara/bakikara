<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | bakikara.xyz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* TEMA RENKLERİ */
        :root {
            --primary-color: #5d3f6a;       /* Kapalı Mor Vurgu */
            --bg-dark: #1e1e2d;             /* Koyu Arka Plan */
            --bg-card: #27293d;             /* Koyu Kart Arka Planı */
            --text-light: #e0e0e0;          /* Açık Metin */
            --text-secondary: #a9a9b6;      /* İkincil Metin */
            --border-dark: #3b3b51;         /* Koyu Sınır */
            --danger-color: #e74c3c;        /* Kırmızı (Sil/Çıkış) */
            --success-color: #28a745;       /* Yeşil (Yayında) */
            --warning-color: #ffc107;       /* Sarı (Onay Bekliyor) */
            --info-color: #007bff;          /* Mavi (Dosya Bekleniyor) */
            --suspend-color: #f39c12;       /* Turuncu (Askıda) */
            --passive-color: #7f8c8d;       /* Gri (Pasif) */
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* GENEL STİL */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-light);
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        .container {
            max-width: 1600px; 
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        /* KONTROL ALANI VE ÖZET KARTLARI */
        .controls-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Üst hizalama */
            flex-wrap: wrap; /* Küçük ekranlarda alt alta gelme */
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-group {
            display: flex;
            gap: 20px; 
            flex-wrap: wrap;
        }
        
        .summary-card {
            background-color: var(--bg-card);
            padding: 15px 25px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--shadow);
            min-width: 180px; 
            transition: transform 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card strong {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        
        .summary-card.active-card { border-left-color: var(--success-color); }
        .summary-card.pending-card { border-left-color: var(--warning-color); }


        /* FİLTRE ALANI */
        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #statusFilter, #searchFilter {
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #statusFilter {
            width: 200px;
        }
        #searchFilter {
             width: 300px;
        }


        /* TABLO STİLLERİ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }
        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-dark);
        }
        .admin-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer; 
        }
        .admin-table th .sort-icon {
            margin-left: 5px;
            font-size: 0.7em;
            color: #d1c4e9;
        }
        .admin-table tr:hover td {
            background-color: #2e3046;
        }
        .admin-table td {
            color: var(--text-light);
            font-size: 0.9em;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 100px; 
            text-align: center;
        }
        .status-pending { background-color: var(--warning-color); color: #333; }
        .status-active { background-color: var(--success-color); color: white; }
        .status-file { background-color: var(--info-color); color: white; }
        .status-suspended { background-color: var(--suspend-color); color: white; }
        .status-passive { background-color: var(--passive-color); color: white; }
        .action-btn {
            background-color: var(--info-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }
        .action-btn:hover {
            opacity: 0.9;
        }
        .action-btn.delete-btn {
            background-color: var(--danger-color);
        }
        .action-btn.detail-btn {
            background-color: #00bcd4;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 20px;
            right: 20px;
            transition: background-color 0.3s;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        #loading, #error-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        /* DUYURU ALANI STİLLERİ */
        .announcement-area {
            margin-top: 40px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .announcement-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        #announcementText {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            resize: vertical;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        #publishAnnouncementBtn {
            background-color: var(--primary-color);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #publishAnnouncementBtn:hover {
            background-color: #7b578c;
        }

        /* AKTİVİTE ALANI STİLLERİ */
        .activity-area {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .activity-area h2 {
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-list li {
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-dark);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-list li:last-child {
            border-bottom: none;
        }
        .activity-meta {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-left: 10px;
            min-width: 120px; /* Tarih/saat için yer ayır */
            text-align: right;
        }
        .activity-text {
            flex-grow: 1;
            text-align: left;
            padding-right: 10px;
        }

        /* MODAL (Özel Pencere) STİLLERİ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Varsayılan olarak gizli */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        .modal-input-group label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        .modal-input-group input, .modal-input-group select, .modal-input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Tasarım */
        @media (max-width: 900px) {
            .controls-area {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .summary-group, .filter-group {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .summary-card {
                width: 100%;
                min-width: unset;
            }
            #statusFilter, #searchFilter {
                 width: 100%;
            }
            .admin-table thead {
                display: none; 
            }
            .admin-table, .admin-table tbody, .admin-table tr, .admin-table td {
                display: block;
                width: 100%;
            }
            .admin-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-dark);
                border-radius: 8px;
            }
            .admin-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: none;
            }
            .admin-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--primary-color);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="logout-btn" onclick="handleLogout()">Çıkış Yap</button>
    <h1><i class="fas fa-user-shield"></i> Yönetici Paneli - Müşteriler</h1>

    <div class="controls-area">
        <div class="summary-group">
            <div class="summary-card total-card">
                Toplam Müşteri: <strong id="totalCustomers">0</strong>
            </div>
            <div class="summary-card active-card">
                Aktif/Yayında: <strong id="activeCustomers">0</strong>
            </div>
            <div class="summary-card pending-card">
                Onay Bekleyen: <strong id="pendingCustomers">0</strong>
            </div>
        </div>
        <div class="filter-group">
            <select id="statusFilter" onchange="filterCustomers()">
                 <option value="ALL">Tüm Durumlar</option>
                 <option value="ACTIVE">YAYINDA</option>
                 <option value="PENDING">Onay Bekliyor</option>
                 <option value="SUSPENDED">ASKIYA ALINDI</option>
                 <option value="PASSIVE">PASİF</option>
                 <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
            <input type="text" id="searchFilter" placeholder="E-posta veya kullanıcı adı ile ara..." onkeyup="filterCustomers()">
        </div>
    </div>
    <div class="announcement-area">
        <h2><i class="fas fa-bullhorn"></i> Yeni Duyuru Yayınla</h2>
        <div class="announcement-card">
            <textarea id="announcementText" placeholder="Müşterilerinize göndermek istediğiniz duyuru metnini buraya yazın..." rows="3"></textarea>
            <button id="publishAnnouncementBtn" class="action-btn">Duyuruyu Yayınla</button>
            <p id="announcementMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        </div>
    </div>
    <div id="loading">Müşteri verileri yükleniyor...</div>
    <div id="error-message" style="display:none;"></div>
    
    <table class="admin-table" id="customerTable" style="display:none;">
        <thead>
            <tr>
                <th onclick="sortCustomers('email')">E-posta / Site Adı <span id="sortEmail" class="sort-icon fas fa-sort"></span></th>
                <th onclick="sortCustomers('createdAt')">Kayıt Tarihi <span id="sortCreatedAt" class="sort-icon fas fa-sort-down"></span></th>
                <th onclick="sortCustomers('balance')">Bakiye (₺) <span id="sortBalance" class="sort-icon fas fa-sort"></span></th>
                <th>Site Adresi (Öneri)</th>
                <th onclick="sortCustomers('serviceStatus')">Durum <span id="sortStatus" class="sort-icon fas fa-sort"></span></th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody id="customerTableBody">
        </tbody>
    </table>
    <div class="activity-area">
        <h2><i class="fas fa-history"></i> Son Yönetici Aktivitesi (Duyurular)</h2>
        <ul id="announcementList" class="activity-list">
            <li>Aktivite yükleniyor...</li>
        </ul>
    </div>
    </div>

<div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle">Mesaj</h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button id="modalConfirmBtn" class="action-btn" style="background-color: var(--success-color);">Onayla</button>
            <button id="modalCancelBtn" class="action-btn" style="background-color: var(--passive-color);">Kapat</button>
        </div>
    </div>
</div>

<div id="detailModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3><i class="fas fa-edit"></i> Müşteri Detaylarını Düzenle</h3>
        <div class="modal-input-group">
            <label for="detailEmail">E-posta:</label>
            <input type="text" id="detailEmail" disabled>
        </div>
        <div class="modal-input-group">
            <label for="detailSiteName">Site Adı:</label>
            <input type="text" id="detailSiteName">
        </div>
        <div class="modal-input-group">
            <label for="detailBalance">Bakiye (₺):</label>
            <input type="number" id="detailBalance" step="0.01">
        </div>
        <div class="modal-input-group">
            <label for="detailStatus">Durum:</label>
            <select id="detailStatus">
                <option value="ACTIVE">YAYINDA</option>
                <option value="PENDING">Onay Bekliyor</option>
                <option value="SUSPENDED">ASKIYA ALINDI</option>
                <option value="PASSIVE">PASİF</option>
                <option value="FILE_WAITING">Dosya Bekleniyor</option>
            </select>
        </div>
        <div class="modal-input-group">
            <label for="detailNotes">Yönetici Notları:</label>
            <textarea id="detailNotes" rows="3" placeholder="Bu müşteriyle ilgili önemli notlarınızı buraya yazın."></textarea>
        </div>
        <p id="detailMessage" style="margin-top: 10px; color: var(--text-light);"></p>
        <div class="modal-buttons">
            <button id="saveDetailsBtn" class="action-btn" style="background-color: var(--primary-color);">Kaydet</button>
            <button id="closeDetailModalBtn" class="action-btn" style="background-color: var(--passive-color);">İptal</button>
        </div>
    </div>
</div>
<script type="module">
    // Firebase SDK Importları 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    // GÜVENLİK UYARISI: Firebase konfigürasyonunuzu bu alana yapıştırın.
    const firebaseConfig = {
        apiKey: "AIzaSyATqhJsWJGv3AxdvLmCKS-T9UlDycwhXys",       // ⬅️ KENDİ ANAHTARINIZI EKLEYİN
        authDomain: "baki-s2-hosting.firebaseapp.com",   // ⬅️ KENDİ ALAN ADINIZI EKLEYİN
        projectId: "baki-s2-hosting",        // ⬅️ KENDİ PROJE ID'NİZİ EKLEYİN
        storageBucket: "baki-s2-hosting.firebasestorage.app", 
        messagingSenderId: "1096636788468", 
        appId: "1:1096636788468:web:ef3365f47930ab98a738a1"             
    };

    // Firebase'i Başlat
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // YÖNETİCİ AYARI VE DEĞİŞKENLER
    // LÜTFEN BU EMAIL ADRESİNİ KENDİ YÖNETİCİ EMAIL ADRESİNİZLE DEĞİŞTİRİN
    const ADMIN_EMAIL = "mehmeteminacan13@gmail.com"; 
    
    const loading = document.getElementById('loading');
    const table = document.getElementById('customerTable');
    const tableBody = document.getElementById('customerTableBody');
    const errorMessage = document.getElementById('error-message');
    
    const totalCustomersSpan = document.getElementById('totalCustomers');
    const activeCustomersSpan = document.getElementById('activeCustomers');
    const pendingCustomersSpan = document.getElementById('pendingCustomers');
    const announcementList = document.getElementById('announcementList');
    
    let allCustomers = [];
    let currentEditingUser = null; 
    let sortKey = 'createdAt'; 
    let sortDirection = 'desc'; 

    // ----------------------------------------------------------------------
    // 1. ÖZEL MODAL İŞLEVLERİ (Alert/Confirm Yerine)
    // ----------------------------------------------------------------------

    /**
     * Özel bir onay (confirm) veya bildirim (alert) penceresi gösterir.
     */
    function showModal(title, message, type = 'alert', callback = () => {}) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        if (type === 'confirm') {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                callback(true); 
            };
            cancelBtn.innerText = 'İptal';
        } else {
            confirmBtn.style.display = 'none';
            cancelBtn.innerText = 'Kapat';
        }

        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            if (type === 'confirm') {
                 callback(false); 
            }
        };

        modal.style.display = 'flex';
    }


    // ----------------------------------------------------------------------
    // 2. MÜŞTERİ TABLOSU ve FİLTRE/SIRA İŞLEVLERİ
    // ----------------------------------------------------------------------
    
    /**
     * Müşteri Durumları ve Etiket Oluşturma Fonksiyonu
     */
    function getStatusBadge(status) {
        let className = 'status-file';
        let text = 'Dosya Bekleniyor';
        
        switch (status) {
            case 'ACTIVE':
                className = 'status-active';
                text = 'YAYINDA';
                break;
            case 'PENDING':
                className = 'status-pending';
                text = 'Onay Bekliyor';
                break;
            case 'SUSPENDED':
                className = 'status-suspended';
                text = 'ASKIYA ALINDI';
                break;
            case 'PASSIVE':
                className = 'status-passive';
                text = 'PASİF';
                break;
            case 'FILE_WAITING':
            default:
                className = 'status-file';
                text = 'Dosya Bekleniyor';
                break;
        }
        return `<span class="status-badge ${className}" data-status="${status}">${text}</span>`;
    }

    /**
     * Müşteri verilerini tabloya işleyen ana render fonksiyonu
     */
    function renderTable(customers) {
        // Sıralama uygula
        customers.sort((a, b) => {
            let aVal = a[sortKey];
            let bVal = b[sortKey];

            // Tarih ve Bakiye alanları için dönüşüm
            if (sortKey === 'createdAt') {
                if (aVal && aVal.toDate) aVal = aVal.toDate().getTime();
                if (bVal && bVal.toDate) bVal = bVal.toDate().getTime();
            }
            if (sortKey === 'balance') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        tableBody.innerHTML = '';

        // Sıralama ikonu güncelleme
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
        });
        const currentSortIcon = document.getElementById(`sort${sortKey.charAt(0).toUpperCase() + sortKey.slice(1)}`);
        if (currentSortIcon) {
             currentSortIcon.classList.remove('fa-sort');
             currentSortIcon.classList.add(sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        }

        if (customers.length === 0) {
            // Tablo sütun sayısı 6 oldu (E-posta, Tarih, Bakiye, Adres, Durum, İşlemler)
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--warning-color);">Filtreye uyan müşteri bulunamadı.</td></tr>`;
            return;
        }

        customers.forEach(user => {
            const userEmail = user.email || 'Bilinmiyor';
            const username = userEmail.split('@')[0];
            const siteUrl = `bakikara.xyz/${user.site_adi || username}`; // Site adı varsa onu kullan
            const regDate = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Bilinmiyor';
            const status = user.serviceStatus || 'FILE_WAITING'; 
            const balance = (user.balance || 0).toFixed(2); // Bakiye değeri

            const row = tableBody.insertRow();
            
            row.innerHTML = `
                <td data-label="E-posta / Site Adı">
                    <strong>${userEmail}</strong><br>
                    <span style="color:var(--text-secondary);">${user.site_adi || 'Site Adı Yok'}</span>
                </td>
                <td data-label="Kayıt Tarihi">${regDate}</td>
                <td data-label="Bakiye (₺)">₺ ${balance}</td>
                <td data-label="Site Adresi (Öneri)"><a href="http://${siteUrl}" target="_blank" style="color:var(--info-color);">${siteUrl}</a></td>
                <td data-label="Durum">${getStatusBadge(status)}</td>
                <td data-label="İşlemler">
                    <button class="action-btn detail-btn" onclick="window.showCustomerDetailModal('${user.userId}')"><i class="fas fa-search"></i> Detay/Düzenle</button>
                    <button class="action-btn open-site-btn" onclick="window.openCustomerSite('${siteUrl}')"><i class="fas fa-external-link-alt"></i> Siteyi Aç</button>
                    <button class="action-btn" onclick="window.updateCustomerStatus('${user.userId}', 'ACTIVE')"><i class="fas fa-check"></i> Yayına Al</button>
                    <button class="action-btn delete-btn" onclick="window.deleteCustomer('${user.userId}')"><i class="fas fa-trash-alt"></i> Sil</button>
                </td>
            `;
        });
    }

    /**
     * Tablo başlığına tıklandığında sıralama yapar
     */
    window.sortCustomers = function(key) {
        if (sortKey === key) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortKey = key;
            sortDirection = 'asc'; 
            if (key === 'createdAt' || key === 'balance') sortDirection = 'desc'; 
        }
        filterCustomers(); // Veriyi yeniden render et
    }

    /**
     * Arama ve Durum Filtreleme Fonksiyonu
     */
    window.filterCustomers = function() {
        const searchText = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value; // Yeni filtre

        const filtered = allCustomers.filter(user => {
            const userEmail = (user.email || '').toLowerCase();
            const username = userEmail.split('@')[0].toLowerCase();
            const siteAdi = (user.site_adi || '').toLowerCase();
            const status = (user.serviceStatus || 'FILE_WAITING');
            
            // Metin araması kontrolü
            const textMatch = userEmail.includes(searchText) || username.includes(searchText) || siteAdi.includes(searchText);
            
            // Durum filtresi kontrolü
            const statusMatch = statusFilter === 'ALL' || status === statusFilter;

            return textMatch && statusMatch;
        });

        renderTable(filtered);
    }

    // ----------------------------------------------------------------------
    // 3. GERÇEK ZAMANLI VERİ ÇEKME (onSnapshot)
    // ----------------------------------------------------------------------

    /**
     * Müşteri Verilerini Gerçek Zamanlı Dinleme ve Özet Kartları Güncelleme
     */
    function listenForCustomers() {
        loading.style.display = 'block';
        table.style.display = 'none';
        errorMessage.style.display = 'none';

        const usersRef = collection(db, "users");
        
        const unsubscribe = onSnapshot(query(usersRef), (snapshot) => {
            try {
                loading.style.display = 'none';
                table.style.display = 'table';
                
                if (snapshot.empty) {
                    loading.innerText = 'Henüz kayıtlı müşteri bulunmamaktadır.';
                    loading.style.display = 'block';
                    totalCustomersSpan.innerText = '0';
                    activeCustomersSpan.innerText = '0';
                    pendingCustomersSpan.innerText = '0';
                    allCustomers = [];
                    renderTable([]);
                    return;
                }

                allCustomers = snapshot.docs.map(doc => ({
                    userId: doc.id,
                    ...doc.data()
                }));

                // Özet Kartları Güncelle
                const activeCount = allCustomers.filter(u => u.serviceStatus === 'ACTIVE').length;
                const pendingCount = allCustomers.filter(u => u.serviceStatus === 'PENDING' || u.serviceStatus === 'FILE_WAITING').length;
                
                totalCustomersSpan.innerText = allCustomers.length;
                activeCustomersSpan.innerText = activeCount;
                pendingCustomersSpan.innerText = pendingCount; 

                // Mevcut filtre ve sıralama ayarlarını kullanarak tabloyu yeniden çiz
                filterCustomers();

            } catch (error) {
                console.error("Gerçek zamanlı veri dinlenirken hata oluştu:", error);
                loading.style.display = 'none';
                errorMessage.innerText = `Veri dinleme hatası: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        });
        
        return unsubscribe;
    }
    
    /**
     * En son yayınlanan duyuruları (aktivite) dinler.
     */
    function listenForRecentActivity() {
        console.log("Aktivite dinleyicisi başlatıldı...");
        
        const announcementsRef = collection(db, "announcements");
        // En son 5 duyuruyu çekmek için sorgu
        const q = query(announcementsRef, orderBy('createdAt', 'desc'), limit(5));
        
        onSnapshot(q, (snapshot) => {
            announcementList.innerHTML = ''; 
            
            if (snapshot.empty) {
                announcementList.innerHTML = `<li><i class="fas fa-info-circle"></i> Henüz yayınlanmış bir duyuru yok.</li>`;
                return;
            }

            snapshot.docs.forEach(doc => {
                const announcement = doc.data();
                const date = announcement.createdAt.toDate ? announcement.createdAt.toDate().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Bilinmiyor';
                
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="activity-text"><i class="fas fa-bell" style="color:var(--primary-color);"></i> ${announcement.text.substring(0, 70)}${announcement.text.length > 70 ? '...' : ''}</span>
                    <span class="activity-meta">${date}</span>
                `;
                announcementList.appendChild(listItem);
            });

        }, (error) => {
            console.error("Aktivite dinlenirken hata oluştu:", error);
            announcementList.innerHTML = `<li><i class="fas fa-exclamation-triangle" style="color:var(--danger-color);"></i> Aktivite yüklenirken hata oluştu.</li>`;
        });
    }

    // ----------------------------------------------------------------------
    // 4. DUYURU YÖNETİMİ
    // ----------------------------------------------------------------------

    /**
     * Yeni Duyuru Ekleme Fonksiyonu
     */
    async function publishAnnouncement() {
        const textElement = document.getElementById('announcementText');
        const messageElement = document.getElementById('announcementMessage');
        const btn = document.getElementById('publishAnnouncementBtn');
        
        const announcementText = textElement.value.trim();

        if (announcementText.length < 5) {
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = 'Duyuru metni en az 5 karakter olmalıdır.';
            return;
        }

        messageElement.innerText = 'Yayınlanıyor...';
        btn.disabled = true;

        try {
            const announcementRef = collection(db, "announcements"); 
            await addDoc(announcementRef, {
                text: announcementText,
                createdAt: new Date(),
                publishedBy: ADMIN_EMAIL 
            });

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = '✅ Duyuru başarıyla yayınlandı! (Müşteri sitelerinde görünecek)';
            textElement.value = ''; 

        } catch (error) {
            console.error("Duyuru yayınlanırken hata oluştu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Duyuru hatası: ${error.message}`;
        } finally {
            btn.disabled = false;
            setTimeout(() => messageElement.innerText = '', 5000); 
        }
    }
    
    // ----------------------------------------------------------------------
    // 5. MÜŞTERİ İŞLEM FONKSİYONLARI
    // ----------------------------------------------------------------------

    /**
     * Müşteri Durumunu Güncelleme
     */
    window.updateCustomerStatus = function(userId, newStatus) {
        let statusText = '';
        if (newStatus === 'ACTIVE') statusText = 'YAYINA AL';
        else if (newStatus === 'SUSPENDED') statusText = 'ASKIYA AL';
        else statusText = newStatus;
        
        showModal(
            "Durum Güncelleme",
            `Kullanıcı ID: ${userId} durumunu ${statusText} olarak güncellemek istediğinizden emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        const userDocRef = doc(db, "users", userId);
                        await updateDoc(userDocRef, { serviceStatus: newStatus });
                        showModal("Başarılı", `Durum başarıyla ${statusText} olarak güncellendi.`, 'alert');
                    } catch (error) {
                        console.error("Durum güncellenirken hata oluştu:", error);
                        showModal("Hata", "Durum güncellenirken bir hata oluştu: " + error.message, 'alert');
                    }
                }
            }
        );
    }

    /**
     * Müşteriyi Silme
     */
    window.deleteCustomer = function(userId) {
        showModal(
            "Kalıcı Silme Onayı",
            `DİKKAT! Kullanıcı ID: ${userId} kalıcı olarak silinecektir. Bu işlem geri alınamaz. Emin misiniz?`,
            'confirm',
            async (isConfirmed) => {
                if (isConfirmed) {
                    try {
                        await deleteDoc(doc(db, "users", userId));
                        showModal("Başarılı", `Kullanıcı başarıyla silindi.`, 'alert');
                    } catch (error) {
                        console.error("Kullanıcı silinirken hata oluştu:", error);
                        showModal("Hata", "Kullanıcı silinirken bir hata oluştu: " + error.message, 'alert');
                    }
                }
            }
        );
    }
    
    /**
     * Müşterinin Sitesini Açma
     */
    window.openCustomerSite = function(siteUrl) {
        window.open(`http://${siteUrl}`, '_blank');
    }

    // ----------------------------------------------------------------------
    // 6. DETAY/DÜZENLE MODALI İŞLEVLERİ
    // ----------------------------------------------------------------------
    
    window.showCustomerDetailModal = function(userId) {
        const user = allCustomers.find(u => u.userId === userId);
        if (!user) return;

        currentEditingUser = user;
        
        document.getElementById('detailEmail').value = user.email || '';
        document.getElementById('detailSiteName').value = user.site_adi || '';
        document.getElementById('detailBalance').value = (user.balance || 0); // Bakiye değeri
        document.getElementById('detailStatus').value = user.serviceStatus || 'FILE_WAITING';
        document.getElementById('detailNotes').value = user.admin_notes || '';
        document.getElementById('detailMessage').innerText = ''; 
        
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    window.saveCustomerDetails = async function() {
        if (!currentEditingUser) return;

        const btn = document.getElementById('saveDetailsBtn');
        const messageElement = document.getElementById('detailMessage');
        
        btn.disabled = true;
        messageElement.style.color = 'var(--info-color)';
        messageElement.innerText = 'Kaydediliyor...';

        try {
            const userDocRef = doc(db, "users", currentEditingUser.userId);
            
            // Bakiye alanını float olarak kaydetmek için parse et
            const newBalance = parseFloat(document.getElementById('detailBalance').value) || 0; 

            await updateDoc(userDocRef, {
                site_adi: document.getElementById('detailSiteName').value.trim(),
                serviceStatus: document.getElementById('detailStatus').value,
                admin_notes: document.getElementById('detailNotes').value.trim(),
                balance: newBalance, // Güncel bakiye eklendi
                lastUpdated: new Date()
            });

            messageElement.style.color = 'var(--success-color)';
            messageElement.innerText = '✅ Detaylar başarıyla güncellendi!';
            
            setTimeout(() => {
                document.getElementById('detailModal').style.display = 'none';
                currentEditingUser = null;
            }, 1000);

        } catch (error) {
            console.error("Detaylar kaydedilirken hata oluştu:", error);
            messageElement.style.color = 'var(--danger-color)';
            messageElement.innerText = `Hata: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }
    
    document.getElementById('closeDetailModalBtn').addEventListener('click', () => {
        document.getElementById('detailModal').style.display = 'none';
        currentEditingUser = null;
    });

    document.getElementById('saveDetailsBtn').addEventListener('click', saveCustomerDetails);

    // ----------------------------------------------------------------------
    // 7. YETKİLENDİRME ve BAŞLATMA
    // ----------------------------------------------------------------------

    /**
     * Çıkış Yapma İşlemi
     */
    window.handleLogout = function() {
        signOut(auth).then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error("Çıkış hatası:", error);
            showModal("Hata", "Çıkış yaparken bir hata oluştu.", 'alert');
        });
    }

    // Auth Listener
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            // Yönetici Girişi Başarılı: Gerçek zamanlı dinlemeyi başlat
            listenForCustomers();
            listenForRecentActivity(); // Aktivite loglarını başlat
            
            // Duyuru butonunu bağla
            document.getElementById('publishAnnouncementBtn').addEventListener('click', publishAnnouncement);
        } else {
            // Yönetici Değil: Yönlendir
            showModal("Erişim Reddedildi", "Bu sayfa sadece yöneticilere aittir.", 'alert', () => {
                window.location.href = 'login.html'; 
            });
        }
    });
</script>
</body>
</html>
