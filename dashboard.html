<script type="module">
    // Zorunlu Firebase CDN importları (Değişmedi)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Zorunlu global değişkenlerin kullanımı (Değişmedi)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    
    if (!firebaseConfig) {
        console.error("Firebase Configuration is missing.");
        return;
    }

    // Firebase servislerinin başlatılması (Değişmedi)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('debug');

    // Firestore veri yolu sabitleri (Değişmedi)
    const USER_DATA_COLLECTION = 'user_data';
    const USER_DATA_DOC = 'profile';

    let currentUserId = null;
    let activeTab = 'dashboard';

    // --- UTILITY FONKSİYONLAR ---

    // Kart verilerini güncelleme (Değişmedi)
    function updateCard(elementId, value, messageId = null, message = null) {
        const element = document.getElementById(elementId);
        if (element) element.innerText = value;
        if (messageId && message) {
            const msgElement = document.getElementById(messageId);
            if (msgElement) msgElement.innerText = message;
        }
    }
    
    // Yükleme sırasında kartları varsayılan duruma getirme (Değişmedi)
    function setLoadingState() {
        updateCard('userEmail', 'Yükleniyor...');
        updateCard('siteUrl', 'Yükleniyor...');
        updateCard('serviceStatus', 'Kontrol Ediliyor...');
        updateCard('regDate', 'Yükleniyor...');
        document.getElementById('siteUrlLink').href = '#';

        // Durum kartlarını varsayılan renge (warning) döndür
        const statusCard = document.getElementById('serviceStatus').parentElement;
        statusCard.classList.remove('card-success', 'card-primary');
        statusCard.classList.add('card-warning');
    }

    // Tıklanan sekmeye göre içeriği değiştirme (Değişmedi)
    function switchContent(newTab) {
        // Tüm içerik sekmelerini gizle
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });
        // Tüm navigasyon linklerinin 'active' sınıfını kaldır
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });

        // Yeni içeriği göster
        const newContent = document.getElementById(newTab + 'Content');
        if (newContent) {
            newContent.classList.remove('hidden');
        }

        // Karşılık gelen navigasyon linkini bul ve 'active' yap
        let navId;
        if (newTab === 'dashboard') navId = 'dashboardLink';
        else if (newTab === 'fileUpload') navId = 'fileUploadLink';
        else if (newTab === 'support') navId = 'supportLink';
        else if (newTab === 'settings') navId = 'settingsLink';

        const activeNavLink = document.getElementById(navId);
        if (activeNavLink) {
            activeNavLink.classList.add('active');
        }

        activeTab = newTab;

        // Ayarlar sekmesi aktifleşirse verileri güncelle
        if (newTab === 'settings' && auth.currentUser) {
            document.getElementById('settingsEmail').innerText = auth.currentUser.email || 'Bilinmiyor';
            // Kayıt tarihini dashboard kartından kopyala
            document.getElementById('settingsRegDate').innerText = document.getElementById('regDate').innerText; 
        }
    }

    // E-posta adresini panoya kopyalama (Değişmedi)
    window.handleCopy = function(text) {
        const tempInput = document.createElement('input');
        document.body.appendChild(tempInput);
        tempInput.setAttribute('value', text);
        tempInput.select();
        try {
            document.execCommand('copy');
            console.log(`E-posta adresi panoya kopyalandı: ${text}`);
        } catch (err) {
            console.error('Kopyalama hatası:', err);
        }
        document.body.removeChild(tempInput);
    }

    // Çıkış Yapma İşlemi (Değişmedi)
    window.handleLogout = function() {
        signOut(auth).then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error("Çıkış hatası:", error);
        });
    }

    // Navigasyon linklerine tıklama olaylarını bağlama (Sekme değiştirme)
    document.getElementById('dashboardLink').addEventListener('click', (e) => { e.preventDefault(); switchContent('dashboard'); });
    document.getElementById('fileUploadLink').addEventListener('click', (e) => { e.preventDefault(); switchContent('fileUpload'); });
    
    // HATA DÜZELTME: Destek ve Ayarlar linklerinin olay dinleyicileri eklendi
    document.getElementById('supportLink').addEventListener('click', (e) => { e.preventDefault(); switchContent('support'); });
    document.getElementById('settingsLink').addEventListener('click', (e) => { e.preventDefault(); switchContent('settings'); });

    // --- FIREBASE BAĞLANTI VE VERİ ÇEKME İŞLEMLERİ (Değişmedi) ---

    // Oturum Açma Kontrolü ve Veri Dinleme
    onAuthStateChanged(auth, async (user) => {
        setLoadingState();
        
        if (user) {
            currentUserId = user.uid;
            document.getElementById('userEmail').innerText = user.email ? user.email.split('@')[0] : 'Misafir';
            
            // Kullanıcının verisinin saklandığı Firestore yolunu oluşturun (Private Data Kuralı)
            const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, USER_DATA_COLLECTION, USER_DATA_DOC);
            
            // onSnapshot ile gerçek zamanlı veri dinlemesi
            const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                const statusCard = document.getElementById('serviceStatus').parentElement;
                
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const username = user.email ? user.email.split('@')[0] : 'misafir';
                    
                    // 1. Site URL'sini güncelle ve tıklanabilir yap
                    const sitePath = `bakikara.xyz/${username}`;
                    updateCard('siteUrl', sitePath);
                    document.getElementById('siteUrlLink').href = `http://${sitePath}`;

                    // 2. Kayıt Tarihini göster
                    let formattedDate = 'Bilinmiyor';
                    if (userData.createdAt) {
                        // Firestore Timestamp objesini yerel zamana çevir
                        formattedDate = userData.createdAt.toDate().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
                    } else if (user.metadata && user.metadata.creationTime) {
                        // Firebase Auth metadatasından al
                        formattedDate = new Date(user.metadata.creationTime).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
                    }
                    updateCard('regDate', formattedDate);
                    document.getElementById('settingsRegDate').innerText = formattedDate; // Ayarlar sekmesi için

                    // 3. Hizmet Durumunu dinamik olarak göster
                    statusCard.classList.remove('card-success', 'card-warning', 'card-primary');

                    if (userData.isPublished === true) {
                        updateCard('serviceStatus', 'Yayında', 'serviceMessage', 'Siteniz başarılı bir şekilde yayında.');
                        statusCard.classList.add('card-success');
                    } else if (userData.fileUploaded === true && userData.isPublished !== true) {
                        updateCard('serviceStatus', 'İncelemede', 'serviceMessage', 'Dosyanız inceleniyor, kısa süre içinde yayında olacak.');
                        statusCard.classList.add('card-warning');
                    } else {
                        // Varsayılan: Dosya Bekleniyor
                        updateCard('serviceStatus', 'Dosya Bekleniyor', 'serviceMessage', 'Yayın için sitenizi (zip) e-posta ile gönderin.');
                        statusCard.classList.add('card-warning');
                    }
                    
                    document.getElementById('settingsEmail').innerText = user.email || 'Bilinmiyor';

                } else {
                    // Kullanıcı Firestore'da yoksa, ilk kaydı oluştur (simülasyon)
                    const initialUserData = {
                        email: user.email,
                        createdAt: serverTimestamp(),
                        isPublished: false,
                        fileUploaded: false
                    };
                    setDoc(userDocRef, initialUserData, { merge: false })
                        .then(() => console.log("İlk kullanıcı profili oluşturuldu."))
                        .catch(err => console.error("Kullanıcı profili oluşturulurken hata:", err));

                    setLoadingState(); // Veri gelene kadar yükleniyor göster
                }
            }, (error) => {
                // Hata durumunda arayüzü güncelle
                updateCard('userEmail', 'Veri Bağlantı Hatası');
                updateCard('serviceStatus', 'Hata!', 'serviceMessage', 'Verilere erişilemiyor.');
                console.error("Firestore Snapshot Hatası:", error);
            });
            
        } else {
            // Kullanıcı giriş yapmamışsa, giriş sayfasına yönlendir (veya anonim giriş yap)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    // Eğer token varsa ancak kullanıcı yoksa, özel token ile tekrar giriş yapmayı dene
                    signInWithCustomToken(auth, __initial_auth_token).catch(err => {
                        console.error("Özel token ile giriş yapılamadı, anonim olarak deneniyor.", err);
                        signInAnonymously(auth).catch(e => console.error("Anonim giriş de başarısız.", e));
                    });
            } else {
                // Token yoksa anonim giriş yap
                signInAnonymously(auth).catch(err => console.error("Anonim giriş başarısız.", err));
            }
        }
    });
</script>
