<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Kapsamlı SMM Panel | Gemini Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* TEMA RENKLERİ VE GENEL STİL */
        :root {
            --primary-color: #3b82f6; /* Mavi Vurgu */
            --primary-light: #60a5fa;
            --bg-body: #f3f4f6;       /* Açık Gri Arka Plan */
            --bg-card: #ffffff;       /* Kart Arka Planı */
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
        }

        /* Navigasyon Aktifliği için özel stil */
        .nav-active {
            background-color: var(--primary-color);
            color: var(--bg-card);
            border-radius: 0.5rem;
        }
        
        /* Mobil Sidebar Görünüm/Gizleme */
        #sidebar {
            /* Varsayılan olarak mobil cihazlarda gizli (ekran dışına kaydırılmış) */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50; /* Diğer içeriğin üstünde kalması için */
        }
        
        /* Desktop/Tablet (lg breakpoint) için görünür hale getir */
        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0);
                position: fixed;
                height: 100%;
            }
            #mainContent {
                margin-left: var(--sidebar-width);
            }
        }
        
        /* Mobil menü açıldığında ana içeriğin üzerine koymak için */
        .sidebar-open {
            transform: translateX(0) !important;
        }

        .page-center-layout {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-body);
        }
    </style>
</head>
<body>
    
    <!-- Ana Uygulama Konteyneri -->
    <div id="appContainer" class="flex h-screen overflow-hidden">
        
        <!-- Sidebar (Oturum Açıldığında Gösterilir) -->
        <div id="sidebar" 
             class="w-72 bg-gray-800 text-white shadow-xl 
                    fixed inset-y-0 left-0 p-6 
                    lg:relative lg:translate-x-0 transition-transform 
                    flex flex-col transform -translate-x-full"> 
            
            <div class="flex-shrink-0 mb-8">
                <h1 class="text-3xl font-extrabold text-white tracking-wider">Gemini Panel</h1>
            </div>
            
            <!-- Navigasyon Menüsü -->
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="handleNavigation('dashboard')" id="nav-dashboard"
                   class="flex items-center p-3 text-lg font-medium text-gray-300 hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-home w-6"></i>
                    <span class="ml-3">Ana Sayfa</span>
                </a>
                <a href="#" onclick="handleNavigation('newOrder')" id="nav-newOrder"
                   class="flex items-center p-3 text-lg font-medium text-gray-300 hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-cart-plus w-6"></i>
                    <span class="ml-3">Yeni Sipariş</span>
                </a>
                <a href="#" onclick="handleNavigation('orders')" id="nav-orders"
                   class="flex items-center p-3 text-lg font-medium text-gray-300 hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-history w-6"></i>
                    <span class="ml-3">Sipariş Geçmişi</span>
                </a>
                <a href="#" onclick="handleNavigation('profile')" id="nav-profile"
                   class="flex items-center p-3 text-lg font-medium text-gray-300 hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-user-circle w-6"></i>
                    <span class="ml-3">Profil & Bakiye</span>
                </a>
            </nav>
            
            <!-- Çıkış Butonu ve Kullanıcı Bilgisi -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <p class="text-sm font-medium text-gray-400 mb-2">
                    <i class="fas fa-id-badge mr-2"></i>Kullanıcı ID: <span id="currentUserId">Yükleniyor...</span>
                </p>
                <button onclick="handleLogout()"
                        class="w-full flex items-center justify-center p-3 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold transition duration-200 shadow-md">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Çıkış Yap
                </button>
            </div>
        </div>
        
        <!-- Ana İçerik Alanı -->
        <main id="mainContent" 
              class="flex-1 overflow-y-auto w-full transition-all duration-300">
            
            <!-- Mobil Menü Butonu (Sadece Mobil/Tablet) -->
            <button id="mobileMenuButton" 
                    class="lg:hidden fixed top-4 left-4 p-3 bg-blue-600 text-white rounded-full shadow-lg z-50">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Tüm Sayfaları Barındıran Konteyner (Sayfa Geçişi burada yönetilecek) -->
            <div id="pageContainer">
                
                <!-- Oturum Açma Sayfası -->
                <section data-page="login" id="loginPage" class="page-center-layout hidden">
                    <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-xl shadow-2xl transform hover:shadow-3xl transition duration-500">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Giriş Yap</h2>
                        <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit()">
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                                <input type="email" id="email" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Şifre</label>
                                <input type="password" id="password" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" 
                                    class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                                Giriş
                            </button>
                            <button type="button" onclick="handleGoogleSignInSimulation()"
                                    class="w-full mt-3 p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 shadow-lg flex items-center justify-center">
                                <i class="fab fa-google mr-2"></i> Google ile Giriş Yap (Simülasyon)
                            </button>
                        </form>
                        <p class="mt-6 text-center text-gray-600">
                            Hesabın yok mu? 
                            <a href="#" onclick="handleNavigation('register')" class="text-blue-600 hover:text-blue-800 font-medium">Kayıt Ol</a>
                        </p>
                        <div id="authMessage" class="mt-4 text-center font-medium"></div>
                    </div>
                </section>

                <!-- Kayıt Olma Sayfası -->
                <section data-page="register" id="registerPage" class="page-center-layout hidden">
                    <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-xl shadow-2xl transform hover:shadow-3xl transition duration-500">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Kayıt Ol</h2>
                        <form id="registerForm" onsubmit="event.preventDefault(); handleAuthSubmit()">
                            <div class="mb-4">
                                <label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">Adınız/Kullanıcı Adınız</label>
                                <input type="text" id="displayName" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                                <input type="email" id="email" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Şifre</label>
                                <input type="password" id="password" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" 
                                    class="w-full p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">
                                Hesap Oluştur
                            </button>
                        </form>
                        <p class="mt-6 text-center text-gray-600">
                            Zaten hesabın var mı? 
                            <a href="#" onclick="handleNavigation('login')" class="text-green-600 hover:text-green-800 font-medium">Giriş Yap</a>
                        </p>
                        <div id="authMessage" class="mt-4 text-center font-medium"></div>
                    </div>
                </section>

                <!-- Dashboard Sayfası (Oturum Açıldıktan Sonra) -->
                <section data-page="dashboard" id="dashboardPage" class="p-8 hidden">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-3">Kontrol Paneli</h1>
                    
                    <!-- İstatistik Kartları -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Bakiye Kartı -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Güncel Bakiye</p>
                                    <p id="dashboardBalance" class="text-3xl font-bold text-gray-900 mt-1">₺0.00</p>
                                </div>
                                <i class="fas fa-wallet text-3xl text-blue-500 opacity-70"></i>
                            </div>
                        </div>
                        <!-- Toplam Sipariş Kartı -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Toplam Sipariş</p>
                                    <p id="dashboardTotalOrders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <i class="fas fa-shopping-cart text-3xl text-green-500 opacity-70"></i>
                            </div>
                        </div>
                        <!-- Harcanan Tutar Kartı -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Harcanan Tutar</p>
                                    <p id="dashboardTotalSpent" class="text-3xl font-bold text-gray-900 mt-1">₺0.00</p>
                                </div>
                                <i class="fas fa-money-bill-wave text-3xl text-yellow-500 opacity-70"></i>
                            </div>
                        </div>
                        <!-- Bekleyen Sipariş Kartı -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Bekleyen Sipariş</p>
                                    <p id="dashboardPendingOrders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <i class="fas fa-hourglass-half text-3xl text-red-500 opacity-70"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hızlı İşlemler -->
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Hızlı İşlemler</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button onclick="handleNavigation('newOrder')"
                                class="flex flex-col items-center justify-center p-8 bg-blue-100 text-blue-800 rounded-xl shadow-md hover:shadow-xl hover:bg-blue-200 transition duration-300">
                            <i class="fas fa-plus-circle text-4xl mb-2"></i>
                            <span class="text-lg font-bold">Yeni Sipariş Oluştur</span>
                        </button>
                        <button onclick="handleNavigation('orders')"
                                class="flex flex-col items-center justify-center p-8 bg-green-100 text-green-800 rounded-xl shadow-md hover:shadow-xl hover:bg-green-200 transition duration-300">
                            <i class="fas fa-list-alt text-4xl mb-2"></i>
                            <span class="text-lg font-bold">Siparişlerimi Görüntüle</span>
                        </button>
                        <button onclick="handleNavigation('profile')"
                                class="flex flex-col items-center justify-center p-8 bg-yellow-100 text-yellow-800 rounded-xl shadow-md hover:shadow-xl hover:bg-yellow-200 transition duration-300">
                            <i class="fas fa-credit-card text-4xl mb-2"></i>
                            <span class="text-lg font-bold">Bakiye Yükle</span>
                        </button>
                    </div>

                    <!-- Son 5 Sipariş Tablosu (Örnek) -->
                    <h2 class="text-2xl font-semibold text-gray-800 mt-10 mb-4">Son 5 Sipariş</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servis</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Miktar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                </tr>
                            </thead>
                            <tbody id="lastFiveOrdersBody" class="bg-white divide-y divide-gray-200">
                                <!-- Siparişler buraya JS ile yüklenecek -->
                                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Henüz siparişiniz bulunmamaktadır.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Yeni Sipariş Sayfası -->
                <section data-page="newOrder" id="newOrderPage" class="p-8 hidden">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-3">Yeni Sipariş Oluştur</h1>

                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-3xl mx-auto">
                        <form id="newOrderForm">
                            <!-- Platform Seçimi -->
                            <div class="mb-6">
                                <label for="platformSelect" class="block text-lg font-semibold text-gray-800 mb-2">1. Platform Seçin</label>
                                <select id="platformSelect" required
                                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-gray-50">
                                    <option value="" disabled selected>Bir sosyal medya platformu seçin</option>
                                </select>
                            </div>

                            <!-- Kategori Seçimi -->
                            <div class="mb-6">
                                <label for="categorySelect" class="block text-lg font-semibold text-gray-800 mb-2">2. Kategori Seçin</label>
                                <select id="categorySelect" required disabled
                                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-gray-50 disabled:bg-gray-200">
                                    <option value="" disabled selected>Önce platform seçin</option>
                                </select>
                            </div>

                            <!-- Servis Seçimi -->
                            <div class="mb-6">
                                <label for="serviceTypeSelect" class="block text-lg font-semibold text-gray-800 mb-2">3. Servis Seçin</label>
                                <select id="serviceTypeSelect" required disabled
                                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-gray-50 disabled:bg-gray-200">
                                    <option value="" disabled selected>Önce kategori seçin</option>
                                </select>
                            </div>

                            <!-- Link Alanı -->
                            <div class="mb-6">
                                <label for="linkInput" class="block text-lg font-semibold text-gray-800 mb-2">4. Link (URL)</label>
                                <input type="url" id="linkInput" required placeholder="https://instagram.com/kullanici_adi"
                                       class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>

                            <!-- Miktar Alanı -->
                            <div class="mb-8">
                                <label for="quantityInput" class="block text-lg font-semibold text-gray-800 mb-2">5. Miktar</label>
                                <input type="number" id="quantityInput" required min="1" value="1000"
                                       class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                <p id="quantityInfo" class="text-sm text-gray-600 mt-2">Min: 500, Max: 10000</p>
                            </div>

                            <!-- Sipariş Özeti ve Buton -->
                            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                                <h3 class="text-xl font-bold text-blue-800 mb-3">Sipariş Özeti</h3>
                                <p class="text-lg text-gray-700">Birim Fiyat: <span id="servicePrice" class="font-bold text-blue-600">₺0.00</span> / 1000</p>
                                <p class="text-2xl font-bold text-gray-900 mt-2">Toplam Tutar: <span id="totalCost" class="text-blue-700">₺0.00</span></p>
                            </div>

                            <button type="submit" id="submitOrderButton"
                                    class="w-full p-4 bg-green-600 text-white font-bold text-xl rounded-lg hover:bg-green-700 transition duration-300 shadow-xl disabled:bg-gray-400" disabled>
                                Sipariş Ver
                            </button>
                        </form>
                        <div id="orderMessage" class="mt-4 text-center font-medium"></div>
                    </div>
                </section>

                <!-- Siparişler Sayfası -->
                <section data-page="orders" id="ordersPage" class="p-8 hidden">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-3">Sipariş Geçmişim</h1>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servis</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Miktar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tutar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Siparişler buraya JS ile yüklenecek -->
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Siparişler yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- Profil ve Bakiye Sayfası -->
                <section data-page="profile" id="profilePage" class="p-8 hidden">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-3">Profil ve Bakiye İşlemleri</h1>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- Profil Bilgileri Kartı -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Kullanıcı Bilgileri</h2>
                            <p class="text-lg mb-2"><span class="font-medium text-gray-600">Ad/Kullanıcı Adı:</span> <span id="profileDisplayName" class="font-bold text-gray-900">Yükleniyor...</span></p>
                            <p class="text-lg mb-4"><span class="font-medium text-gray-600">E-posta:</span> <span id="profileEmail" class="font-bold text-gray-900">Yükleniyor...</span></p>
                            <p class="text-sm text-gray-500 mt-4">Kullanıcı ID: <span id="profileUserId">Yükleniyor...</span></p>
                        </div>

                        <!-- Bakiye Kartı -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Bakiye Yönetimi</h2>
                            
                            <div class="flex items-center justify-between bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">
                                <p class="text-xl font-medium text-gray-700">Güncel Bakiyeniz:</p>
                                <p id="currentBalance" class="text-4xl font-extrabold text-blue-700">₺0.00</p>
                            </div>

                            <h3 class="text-xl font-semibold text-gray-800 mb-3">Bakiye Yükle (Simülasyon)</h3>
                            <form id="addBalanceForm">
                                <div class="mb-4">
                                    <label for="amountInput" class="block text-md font-medium text-gray-700 mb-1">Yüklenecek Tutar (₺)</label>
                                    <input type="number" id="amountInput" required min="1" value="50" step="0.01"
                                           class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <button type="submit" 
                                        class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg">
                                    Bakiye Yükle
                                </button>
                            </form>
                            <div id="balanceMessage" class="mt-4 text-center font-medium"></div>
                        </div>
                    </div>
                </section>

                <!-- Başarılı İşlem Mesaj Modalı (Modal) -->
                <div id="modalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[100] items-center justify-center">
                    <div id="successModal" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform scale-90 transition-transform duration-300">
                        <div class="text-center">
                            <i id="modalIcon" class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-3">Başarılı!</h3>
                            <p id="modalMessage" class="text-gray-600 mb-6">İşleminiz başarıyla tamamlandı.</p>
                            <button onclick="closeModal()" 
                                    class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">
                                Kapat
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Firebase SDK'ları -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEREKLİ GLOBAL DEĞİŞKENLER ---
        let app, db, auth, userId, isFirebaseInitialized = false;
        
        // Canvas ortamından gelen global değişkenleri güvenle kullanma
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Uygulama Durumu
        const appState = {
            isAuthenticated: false,
            currentPage: 'login', // Başlangıçta giriş sayfası
            userProfile: null,
            servicesData: {}, // Tüm servis, kategori ve platform verilerini tutar
            userOrders: []
        };
        
        // --- FIREBASE BAŞLATMA VE AUTH İŞLEMLERİ ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            isFirebaseInitialized = true;
            console.log("Firebase başarıyla başlatıldı.");

            // Kütüphaneden gelen kullanıcı tokeni ile oturum açma veya anonim giriş
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Özel token ile oturum açılamadı, anonim giriş denenecek:", e);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
            
            // Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    appState.isAuthenticated = !user.isAnonymous; // Anonim değilse oturum açık say
                    console.log("Kullanıcı durumu değişti. UID:", userId);

                    // Eğer gerçek bir kullanıcıysa (anonim değilse)
                    if (appState.isAuthenticated) {
                         // Profil ve Servis verilerini yükle ve anlık dinlemeye başla
                        setupRealtimeListeners();
                        // İlk sayfayı dashboard olarak ayarla
                        if(appState.currentPage === 'login' || appState.currentPage === 'register') {
                            appState.currentPage = 'dashboard';
                        }
                    } else {
                        // Anonim veya Token hatası varsa giriş sayfasına yönlendir
                        appState.currentPage = 'login';
                        appState.isAuthenticated = false; // Anonim kullanıcıyı oturum açmış gibi gösterme
                    }
                } else {
                    // Kullanıcı çıkış yapmış veya oturum açmamışsa
                    userId = null;
                    appState.isAuthenticated = false;
                    appState.currentPage = 'login';
                }
                updateUI();
            });

        } catch (error) {
            console.error("Firebase başlatılırken hata:", error);
            document.getElementById('authMessage').textContent = "Uygulama başlatılırken bir hata oluştu. Lütfen konsolu kontrol edin.";
            updateUI(); // Firebase başlatılmasa bile UI'ı başlat
        }


        // --- FIRESTORE YOL YARDIMCI FONKSİYONLARI ---
        const getProfileDocRef = (uid) => doc(db, `/artifacts/${appId}/users/${uid}/profile/main`);
        const getOrdersCollectionRef = (uid) => collection(db, `/artifacts/${appId}/users/${uid}/orders`);
        const getPublicDataRef = () => doc(db, `/artifacts/${appId}/public/data/service_data/latest`);

        // --- REALTIME LİSTENER KURULUMU ---
        function setupRealtimeListeners() {
            if (!userId) return;

            // 1. Profil ve Bakiye Dinleyicisi
            onSnapshot(getProfileDocRef(userId), (docSnap) => {
                if (docSnap.exists()) {
                    appState.userProfile = docSnap.data();
                    console.log("Profil verisi güncellendi.");
                } else {
                    // İlk defa giriş yapan kullanıcı için varsayılan profil oluştur
                    console.log("Profil yok, varsayılan oluşturulacak.");
                    initializeUserProfile(auth.currentUser);
                }
                updateUI();
            }, (error) => console.error("Profil dinlenirken hata:", error));

            // 2. Servis Verileri Dinleyicisi (Tüm kullanıcılar için ortak)
            onSnapshot(getPublicDataRef(), (docSnap) => {
                if (docSnap.exists()) {
                    appState.servicesData = docSnap.data().data || {};
                    console.log("Servis verileri güncellendi.");
                    populateServiceDropdowns(); // Dropdownları doldur
                } else {
                    console.log("Servis verisi yok, varsayılan oluşturulacak.");
                    initializeServiceData(); // Varsayılan servis verilerini oluştur
                }
                updateUI();
            }, (error) => console.error("Servis verisi dinlenirken hata:", error));

            // 3. Siparişler Dinleyicisi
            const ordersQuery = query(getOrdersCollectionRef(userId));
            onSnapshot(ordersQuery, (snapshot) => {
                appState.userOrders = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000) : new Date()
                })).sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime()); // En yeniyi üste koy
                
                console.log(`${appState.userOrders.length} sipariş güncellendi.`);
                updateUI();
            }, (error) => console.error("Siparişler dinlenirken hata:", error));
        }

        // --- İLK VERİ OLUŞTURMA FONKSİYONLARI ---
        
        // Kullanıcı profilini ilk kez oluşturur
        async function initializeUserProfile(user) {
            const profileRef = getProfileDocRef(user.uid);
            await setDoc(profileRef, {
                displayName: user.displayName || "Yeni Kullanıcı",
                email: user.email || "Anonim Kullanıcı",
                balance: 100.00, // Başlangıç bakiyesi
                totalSpent: 0.00,
                createdAt: serverTimestamp()
            }, { merge: true }).catch(e => console.error("Profil oluşturulurken hata:", e));
        }

        // Varsayılan servis verilerini oluşturur (Public alana yazar)
        async function initializeServiceData() {
            const defaultData = {
                "Instagram": {
                    "Takipçi": {
                        "Hızlı Takipçi": { min: 500, max: 10000, pricePerK: 15.00, desc: "Anında teslimat, garantili." },
                        "Normal Takipçi": { min: 100, max: 50000, pricePerK: 7.50, desc: "Yavaş ve doğal artış." }
                    },
                    "Beğeni": {
                        "Türk Beğeni": { min: 100, max: 20000, pricePerK: 5.00, desc: "Yüksek kaliteli Türk hesaplar." }
                    }
                },
                "X (Twitter)": {
                    "Retweet": {
                        "Hızlı Retweet": { min: 50, max: 5000, pricePerK: 4.00, desc: "Hızlı etkileşim." }
                    }
                }
            };

            await setDoc(getPublicDataRef(), { data: defaultData, lastUpdated: serverTimestamp() }, { merge: true })
                .then(() => console.log("Varsayılan servis verileri oluşturuldu."))
                .catch(e => console.error("Servis verisi oluşturulurken hata:", e));
        }
        

        // --- YARDIMCI FONKSİYONLAR ---

        // Dropdown'ları doldurur ve event listener'ları kurar
        function populateServiceDropdowns() {
            const platformSelect = document.getElementById('platformSelect');
            const categorySelect = document.getElementById('categorySelect');
            const serviceTypeSelect = document.getElementById('serviceTypeSelect');

            // Temizle
            platformSelect.innerHTML = '<option value="" disabled selected>Bir sosyal medya platformu seçin</option>';
            categorySelect.innerHTML = '<option value="" disabled selected>Önce platform seçin</option>';
            serviceTypeSelect.innerHTML = '<option value="" disabled selected>Önce kategori seçin</option>';
            categorySelect.disabled = true;
            serviceTypeSelect.disabled = true;

            const data = appState.servicesData;
            
            // Platformları doldur
            Object.keys(data).forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                platformSelect.appendChild(option);
            });

            // Event Listeners'ı (Eğer henüz eklenmemişse)
            if (!platformSelect.hasAttribute('data-listeners-added')) {
                platformSelect.addEventListener('change', () => {
                    const selectedPlatform = platformSelect.value;
                    const categories = data[selectedPlatform];
                    
                    categorySelect.innerHTML = '<option value="" disabled selected>Bir kategori seçin</option>';
                    serviceTypeSelect.innerHTML = '<option value="" disabled selected>Önce kategori seçin</option>';
                    
                    if (categories) {
                        Object.keys(categories).forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            categorySelect.appendChild(option);
                        });
                        categorySelect.disabled = false;
                        serviceTypeSelect.disabled = true;
                    }
                    updateOrderSummary();
                });
                categorySelect.addEventListener('change', () => {
                    const selectedPlatform = platformSelect.value;
                    const selectedCategory = categorySelect.value;
                    const services = data[selectedPlatform]?.[selectedCategory];

                    serviceTypeSelect.innerHTML = '<option value="" disabled selected>Bir servis seçin</option>';
                    
                    if (services) {
                        Object.keys(services).forEach(serviceName => {
                            const option = document.createElement('option');
                            option.value = serviceName;
                            option.textContent = serviceName;
                            serviceTypeSelect.appendChild(option);
                        });
                        serviceTypeSelect.disabled = false;
                    }
                    updateOrderSummary();
                });
                serviceTypeSelect.addEventListener('change', updateOrderSummary);
                document.getElementById('quantityInput')?.addEventListener('input', updateOrderSummary);

                platformSelect.setAttribute('data-listeners-added', 'true');
            }

            // Eğer form elementleri varsa ilk hesaplamayı tetikle
            if(appState.currentPage === 'newOrder') {
                updateOrderSummary();
            }
        }
        
        // Sipariş formundaki tutar ve limitleri günceller
        function updateOrderSummary() {
            const platform = document.getElementById('platformSelect')?.value;
            const category = document.getElementById('categorySelect')?.value;
            const serviceName = document.getElementById('serviceTypeSelect')?.value;
            const quantityInput = document.getElementById('quantityInput');
            
            const servicePriceEl = document.getElementById('servicePrice');
            const totalCostEl = document.getElementById('totalCost');
            const quantityInfoEl = document.getElementById('quantityInfo');
            const submitButton = document.getElementById('submitOrderButton');

            // Varsayılan değerler
            let pricePerK = 0;
            let minQty = 1;
            let maxQty = 999999;
            let totalCost = 0;
            
            // Servis detaylarını bul
            const serviceDetails = appState.servicesData?.[platform]?.[category]?.[serviceName];

            if (serviceDetails && quantityInput) {
                pricePerK = serviceDetails.pricePerK || 0;
                minQty = serviceDetails.min || 1;
                maxQty = serviceDetails.max || 999999;

                // Miktarı al ve limitleri kontrol et
                const quantity = parseInt(quantityInput.value) || 0;
                
                // Toplam Tutar Hesaplama: (Miktar / 1000) * Birim Fiyat
                totalCost = (quantity / 1000) * pricePerK;
                
                // Miktar inputunu güncelle ve geçerliliğini kontrol et
                quantityInput.min = minQty;
                quantityInput.max = maxQty;
                
                quantityInfoEl.textContent = `Min: ${minQty}, Max: ${maxQty}. ${serviceDetails.desc || ''}`;
                
                // Tutarın geçerli olup olmadığını kontrol et
                const isFormValid = quantity >= minQty && quantity <= maxQty && totalCost > 0 && 
                                    platform && category && serviceName;
                
                submitButton.disabled = !isFormValid;

            } else {
                // Servis seçilmemişse
                quantityInfoEl.textContent = "Lütfen önce bir servis seçin.";
                submitButton.disabled = true;
            }

            servicePriceEl.textContent = `₺${pricePerK.toFixed(2)}`;
            totalCostEl.textContent = `₺${totalCost.toFixed(2)}`;
        }


        // --- İŞLEM FONKSİYONLARI ---

        // Oturum Açma/Kayıt olma işlemini yönetir
        async function handleAuthSubmit() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authMessageEl = document.getElementById('authMessage');
            authMessageEl.textContent = "İşleniyor...";
            
            if (appState.currentPage === 'login') {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    authMessageEl.textContent = "Giriş başarılı!";
                    // onAuthStateChanged listener'ı dashboard'a yönlendirecektir.
                } catch (error) {
                    authMessageEl.textContent = `Giriş Hatası: ${error.message}`;
                    console.error("Giriş hatası:", error);
                }
            } else if (appState.currentPage === 'register') {
                const displayName = document.getElementById('displayName').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: displayName });
                    await initializeUserProfile(userCredential.user);
                    
                    authMessageEl.textContent = "Kayıt başarılı! Giriş yapılıyor...";
                    // onAuthStateChanged listener'ı dashboard'a yönlendirecektir.
                } catch (error) {
                    authMessageEl.textContent = `Kayıt Hatası: ${error.message}`;
                    console.error("Kayıt hatası:", error);
                }
            }
        }
        
        // Simülasyon Google Girişi
        function handleGoogleSignInSimulation() {
            showModal('info', 'Google Girişi', 'Bu, sadece bir simülasyondur. Gerçek bir Google girişi entegrasyonu için ek yapılandırma gereklidir. Varsayılan kullanıcıyla giriş yapılıyor...');
            
            // Varsayılan bir kullanıcı adı ve şifre ile giriş yapma simülasyonu
            document.getElementById('email').value = "test@geminipanel.com";
            document.getElementById('password').value = "123456";
            
            // Otomatik olarak giriş yapmayı tetikle
            setTimeout(() => {
                handleAuthSubmit();
            }, 1500);
        }

        // Çıkış işlemi
        async function handleLogout() {
            try {
                await signOut(auth);
                showModal('success', 'Güle Güle', 'Oturum başarıyla kapatıldı.');
            } catch (error) {
                showModal('error', 'Hata', 'Çıkış yapılırken bir hata oluştu.');
                console.error("Çıkış hatası:", error);
            }
        }

        // Bakiye Yükleme işlemi
        document.getElementById('addBalanceForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amountInput').value);
            const balanceMessageEl = document.getElementById('balanceMessage');
            balanceMessageEl.textContent = "İşleniyor...";

            if (amount <= 0 || isNaN(amount)) {
                balanceMessageEl.textContent = "Lütfen geçerli bir miktar girin.";
                return;
            }

            const profileRef = getProfileDocRef(userId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const profileDoc = await transaction.get(profileRef);

                    if (!profileDoc.exists()) {
                        throw "Profil bulunamadı!";
                    }

                    const newBalance = (profileDoc.data().balance || 0) + amount;
                    
                    // Transaction ile güncelleme
                    transaction.update(profileRef, { balance: newBalance });
                });

                showModal('success', 'Bakiye Yüklendi', `Başarıyla ₺${amount.toFixed(2)} bakiye yüklendi.`);
                balanceMessageEl.textContent = "";

            } catch (e) {
                showModal('error', 'Bakiye Hatası', 'Bakiye yüklenirken bir sorun oluştu.');
                balanceMessageEl.textContent = `Hata: ${e}`;
                console.error("Bakiye yükleme hatası:", e);
            }
        });

        // Yeni Sipariş verme işlemi
        document.getElementById('newOrderForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const platform = document.getElementById('platformSelect').value;
            const category = document.getElementById('categorySelect').value;
            const serviceName = document.getElementById('serviceTypeSelect').value;
            const link = document.getElementById('linkInput').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);
            
            const totalCost = parseFloat(document.getElementById('totalCost').textContent.replace('₺', ''));
            const orderMessageEl = document.getElementById('orderMessage');
            orderMessageEl.textContent = "Siparişiniz işleniyor...";
            
            if (totalCost <= 0) {
                orderMessageEl.textContent = "Sipariş tutarı 0'dan büyük olmalıdır.";
                return;
            }

            const profileRef = getProfileDocRef(userId);
            const ordersCollectionRef = getOrdersCollectionRef(userId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const profileDoc = await transaction.get(profileRef);
                    if (!profileDoc.exists()) throw new Error("Profil bulunamadı!");

                    const currentBalance = profileDoc.data().balance || 0;
                    if (currentBalance < totalCost) {
                        throw new Error("Yetersiz bakiye. Lütfen bakiye yükleyin.");
                    }

                    const newBalance = currentBalance - totalCost;
                    const newTotalSpent = (profileDoc.data().totalSpent || 0) + totalCost;

                    // 1. Profil ve bakiye güncelleme
                    transaction.update(profileRef, { 
                        balance: newBalance,
                        totalSpent: newTotalSpent
                    });

                    // 2. Yeni siparişi ekle
                    const newOrder = {
                        platform,
                        category,
                        serviceName,
                        link,
                        quantity,
                        cost: totalCost,
                        status: 'Pending', // Pending, Processing, Completed, Cancelled
                        createdAt: serverTimestamp()
                    };
                    transaction.set(doc(ordersCollectionRef), newOrder);
                });

                // Başarılı işlem sonrası form sıfırlama ve bildirim
                document.getElementById('newOrderForm').reset();
                orderMessageEl.textContent = "";
                updateOrderSummary();
                showModal('success', 'Siparişiniz Alındı', `Siparişiniz (₺${totalCost.toFixed(2)}) başarıyla oluşturuldu. Bakiye: ₺${(appState.userProfile.balance - totalCost).toFixed(2)}`);

            } catch (error) {
                orderMessageEl.textContent = `Sipariş Hatası: ${error.message}`;
                showModal('error', 'Sipariş Hatası', error.message);
                console.error("Sipariş verme hatası:", error);
            }
        });

        // --- UI/RENDER FONKSİYONLARI ---

        // Sayfa navigasyonunu yönetir
        function handleNavigation(page) {
            appState.currentPage = page;
            updateUI();
            
            // Mobil menü açıksa kapat
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('sidebar-open');
            }
        }
        
        // Modalı gösterir
        function showModal(type, title, message) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            const successModal = document.getElementById('successModal');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalIcon.classList.remove('fa-check-circle', 'fa-times-circle', 'fa-info-circle');
            
            if (type === 'success') {
                modalIcon.classList.add('fa-check-circle', 'text-green-500');
            } else if (type === 'error') {
                modalIcon.classList.add('fa-times-circle', 'text-red-500');
            } else {
                modalIcon.classList.add('fa-info-circle', 'text-blue-500');
            }

            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('flex');
            
            // Modalın scale efekti ile gösterilmesi
            setTimeout(() => {
                successModal.classList.remove('scale-90');
                successModal.classList.add('scale-100');
            }, 10);
        }

        // Modalı gizler
        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            const successModal = document.getElementById('successModal');

            // Modalın scale efekti ile gizlenmesi
            successModal.classList.remove('scale-100');
            successModal.classList.add('scale-90');

            setTimeout(() => {
                modalOverlay.classList.remove('flex');
                modalOverlay.classList.add('hidden');
            }, 300);
        }

        // Sipariş durumuna göre renk döndürür
        function getStatusColor(status) {
            switch (status) {
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'Pending': return 'bg-yellow-100 text-yellow-800';
                case 'Processing': return 'bg-blue-100 text-blue-800';
                case 'Cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Ana kullanıcı arayüzünü (UI) günceller
        function updateUI() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const pageContainer = document.getElementById('pageContainer');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            
            // --- 1. Layout ve Sayfa Görünürlüğü Yönetimi (KRİTİK) ---
            
            if (appState.isAuthenticated) {
                // Oturum açılmış: Sidebar görünür, Ana İçerik kayar
                sidebar.classList.remove('hidden', 'translate-x-full');
                sidebar.classList.add('lg:block', 'lg:relative', 'lg:translate-x-0', 'fixed');
                mainContent.classList.remove('page-center-layout', 'w-full');
                mainContent.classList.add('lg:ml-72');
                mobileMenuButton.classList.remove('hidden');
                
                // Eğer oturum açılmışken giriş/kayıt sayfasındaysa, dashboard'a yönlendir
                if(appState.currentPage === 'login' || appState.currentPage === 'register') {
                    appState.currentPage = 'dashboard';
                }

            } else {
                // Oturum kapalı: Sidebar gizli, Ana İçerik ortalanmış ve tam genişlikte
                sidebar.classList.add('hidden', 'translate-x-full');
                sidebar.classList.remove('lg:block', 'lg:relative', 'lg:translate-x-0', 'fixed');
                mainContent.classList.add('page-center-layout', 'w-full');
                mainContent.classList.remove('lg:ml-72');
                mobileMenuButton.classList.add('hidden');

                // Eğer oturum kapalıyken dashboard gibi bir sayfadaysa, login'e yönlendir
                if(appState.currentPage !== 'login' && appState.currentPage !== 'register') {
                    appState.currentPage = 'login';
                }
            }

            // Sayfa Görünürlüğü Yönetimi
            if (pageContainer) {
                pageContainer.querySelectorAll('section[data-page]').forEach(pageElement => {
                    const isCurrentPage = pageElement.getAttribute('data-page') === appState.currentPage;
                    pageElement.classList.toggle('hidden', !isCurrentPage);
                    // Login/Register sayfaları ortalanmış layout kullanmalı
                    if (appState.currentPage === 'login' || appState.currentPage === 'register') {
                        pageElement.classList.toggle('page-center-layout', isCurrentPage);
                        mainContent.classList.add('p-0'); // İçeriği ortalamak için padding'i kaldır
                    } else {
                        pageElement.classList.remove('page-center-layout');
                        mainContent.classList.remove('p-0');
                    }
                });
            }

            // --- 2. Navigasyon ve Veri Güncelleme ---
            
            // Navigasyon linklerini güncelle
            document.querySelectorAll('nav a').forEach(link => {
                const pageName = link.id.replace('nav-', '');
                link.classList.toggle('nav-active', pageName === appState.currentPage);
            });
            
            // Kullanıcı profili verilerini güncelle
            if (appState.isAuthenticated && appState.userProfile) {
                const profile = appState.userProfile;
                const balance = `₺${(profile.balance || 0).toFixed(2)}`;
                const displayName = profile.displayName || "Tanımsız";
                const email = profile.email || "Tanımsız";
                const spent = `₺${(profile.totalSpent || 0).toFixed(2)}`;
                const totalOrders = appState.userOrders.length;
                const pendingOrders = appState.userOrders.filter(o => o.status === 'Pending' || o.status === 'Processing').length;

                // Dashboard
                document.getElementById('dashboardBalance').textContent = balance;
                document.getElementById('dashboardTotalOrders').textContent = totalOrders;
                document.getElementById('dashboardTotalSpent').textContent = spent;
                document.getElementById('dashboardPendingOrders').textContent = pendingOrders;
                
                // Sidebar
                document.getElementById('currentUserId').textContent = userId ? userId.substring(0, 8) + '...' : 'Yükleniyor...';
                
                // Profile Page
                document.getElementById('currentBalance').textContent = balance;
                document.getElementById('profileDisplayName').textContent = displayName;
                document.getElementById('profileEmail').textContent = email;
                document.getElementById('profileUserId').textContent = userId || 'Yükleniyor...';

                // Sipariş Tablolarını güncelle
                renderOrdersTable();

                // Yeni Sipariş sayfasında dropdownları doldur (veriler yüklendiyse)
                if (Object.keys(appState.servicesData).length > 0) {
                    populateServiceDropdowns();
                }
            }
        }
        
        // Sipariş tablolarını (dashboard ve orders sayfası) render eder
        function renderOrdersTable() {
            const allOrdersBody = document.getElementById('ordersTableBody');
            const lastFiveOrdersBody = document.getElementById('lastFiveOrdersBody');
            
            // Tabloyu temizle
            allOrdersBody.innerHTML = '';
            lastFiveOrdersBody.innerHTML = '';

            if (appState.userOrders.length === 0) {
                allOrdersBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Henüz siparişiniz bulunmamaktadır.</td></tr>';
                lastFiveOrdersBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Henüz siparişiniz bulunmamaktadır.</td></tr>';
                return;
            }

            const formatRow = (order, isDashboard) => {
                const statusColor = getStatusColor(order.status);
                const date = order.createdAt.toLocaleDateString('tr-TR') + ' ' + order.createdAt.toLocaleTimeString('tr-TR');
                const rowContent = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id.substring(0, 6)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.platform}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.serviceName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.quantity}</td>
                    ${!isDashboard ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₺${order.cost.toFixed(2)}</td>` : ''}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                `;
                return `<tr class="hover:bg-gray-50">${rowContent}</tr>`;
            };

            // Tüm siparişler tablosunu doldur
            appState.userOrders.forEach(order => {
                allOrdersBody.insertAdjacentHTML('beforeend', formatRow(order, false));
            });
            
            // Son 5 sipariş tablosunu doldur (Dashboard)
            appState.userOrders.slice(0, 5).forEach(order => {
                lastFiveOrdersBody.insertAdjacentHTML('beforeend', formatRow(order, true));
            });
        }
        
        // --- EVENT LISTENERS VE SON AYARLAR ---
        
        // Mobile menü butonu listener'ı
        document.getElementById('mobileMenuButton')?.addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-open');
        });
        
        // Dışarı tıklama ile mobil menüyü kapatma
        document.addEventListener('click', (event) => {
            const sidebar = document.getElementById('sidebar');
            const menuButton = document.getElementById('mobileMenuButton');
            
            // Eğer mobil menü açıksa ve tıklama sidebar veya butona ait değilse kapat
            if (window.innerWidth < 1024 && sidebar.classList.contains('sidebar-open') && 
                !sidebar.contains(event.target) && !menuButton.contains(event.target)) {
                sidebar.classList.remove('sidebar-open');
            }
        });


        // --- GLOBAL ERİŞİM İÇİN EŞLEŞTİRMELER --
        window.handleNavigation = handleNavigation;
        window.handleLogout = handleLogout;
        window.handleAuthSubmit = handleAuthSubmit;
        window.handleGoogleSignInSimulation = handleGoogleSignInSimulation;
        window.closeModal = closeModal;
        window.updateOrderSummary = updateOrderSummary;
        
        // --- SON YÜKLEME KONTROLÜ ---
        
        // Eğer Firebase başlatılmamışsa (try/catch blokunda hata oluşmuşsa),
        // auth listener'ın çağrılmasını beklemeyiz. UI'ı hemen başlatırız.
        if (!isFirebaseInitialized) {
            updateUI(); 
        }

    </script>
</body>
</html>
