<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP SMM Panel - Giriş & Yönetim</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --bg-dark: #121212; /* Very Dark Gray/Black for modern feel */
            --bg-card: #1f2937; /* Gray-800 */
            --text-light: #e5e7eb; /* Gray-200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            transition: background-color 0.3s;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .input-field {
            background-color: #374151; /* Gray-700 */
            color: var(--text-light);
            border: 1px solid #4b5563;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            background-color: #1f2937; /* Slightly darker on focus */
        }
        .card-bg {
            background-color: var(--bg-card);
            backdrop-filter: blur(10px);
        }
        .hover-lift {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body onload="lucide.createIcons()">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header/Navbar -->
        <header class="bg-black/50 backdrop-blur-md shadow-lg sticky top-0 z-20 border-b border-gray-800">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <a href="#" onclick="changeView('home'); return false;" class="flex items-center space-x-2 text-2xl font-extrabold text-indigo-400 hover:text-indigo-300 transition duration-150">
                    <i data-lucide="zap" class="w-6 h-6"></i>
                    <span>VIP SMM Panel</span>
                </a>
                <div class="flex items-center space-x-4">
                    <button onclick="changeView('privacy')" class="text-sm font-medium text-gray-300 hover:text-white transition duration-150 hidden sm:block">Gizlilik</button>
                    <div id="auth-buttons" class="flex items-center space-x-3">
                        <!-- Buttons will be rendered here by JS -->
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main id="content" class="flex-grow flex items-start justify-center p-4 sm:p-8"></main>

        <!-- Notification Message Box (Modal-like) -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center" onclick="closeMessage()">
            <div class="card-bg p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100 border-t-4 border-indigo-500" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-2xl font-bold mb-3 text-indigo-400 flex items-center"><i data-lucide="bell" class="w-5 h-5 mr-2"></i></h3>
                <p id="message-body" class="text-gray-300 mb-6"></p>
                <button onclick="closeMessage()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">Kapat</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-black/50 text-center text-gray-600 py-4 text-xs mt-8 border-t border-gray-800">
            <p>&copy; 2025 VIP SMM Panel. Tüm Hakları Saklıdır.</p>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            serverTimestamp,
            runTransaction,
            collection,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // 1. GLOBAL DEĞİŞKENLER VE FIREBASE AYARLARI
        // =================================================================

        // Mandatory global variables from Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smm-go-50a17';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUser = null; 
        let currentView = 'home';
        let isAuthReady = false;

        // Real-time data
        let userBalance = 0.00; 
        let orders = []; 
        let unsubscribeBalance = null; 
        let unsubscribeOrders = null; 

        // Firebase Service Instances
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Simulated Service Data (Prices based on 1K quantity)
        const SERVICES = [
            { id: 1, name: "Instagram Takipçi (Hızlı)", pricePerK: 15.00, min: 100, max: 10000 },
            { id: 2, name: "Instagram Beğeni (Türk)", pricePerK: 10.00, min: 50, max: 50000 },
            { id: 3, name: "TikTok İzlenme (Global)", pricePerK: 1.50, min: 1000, max: 500000 },
            { id: 4, name: "Twitter Retweet", pricePerK: 5.00, min: 10, max: 2000 },
        ];


        // =================================================================
        // 2. HELPER FUNCTIONS (UI/ERROR HANDLING & FIRESTORE PATHS)
        // =================================================================

        /** Displays a modal message to the user. */
        window.showMessage = (title, body, isError = false) => {
            const titleEl = document.getElementById('message-title');
            titleEl.innerHTML = `<i data-lucide="${isError ? 'alert-triangle' : 'check-circle'}" class="w-5 h-5 mr-2"></i> ${title}`;
            titleEl.classList.toggle('text-red-400', isError);
            titleEl.classList.toggle('text-indigo-400', !isError);
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
            lucide.createIcons();
        };

        /** Closes the modal message. */
        window.closeMessage = () => {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        };

        /** Formats the user's balance to currency string. */
        const formatBalance = (balance) => {
            return parseFloat(balance).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        /** Firestore Public Document Path Generator */
        const getPublicDocRef = (collectionName, docId) => {
            return doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
        };

        /** Firestore Private User Profile Path Generator */
        const getUserProfileRef = (userId) => {
            // Path: /artifacts/{appId}/users/{userId}/profile/{userId}
            return doc(db, `artifacts/${appId}/users/${userId}/profile`, userId);
        };

        /** Firestore Private User Orders Collection Path Generator */
        const getOrdersCollectionRef = (userId) => {
            // Path: /artifacts/{appId}/users/{userId}/orders
            return collection(db, `artifacts/${appId}/users/${userId}/orders`);
        };


        // =================================================================
        // 3. VIEW MANAGEMENT
        // =================================================================

        const contentElement = document.getElementById('content');
        const authButtonsElement = document.getElementById('auth-buttons');

        /** Navigasyon ve İçerik Görünümünü Değiştirir */
        window.changeView = async (view) => {
            currentView = view;
            window.scrollTo(0, 0); // Scroll to top on view change

            let html = '';
            switch (view) {
                case 'login':
                    html = renderLoginForm();
                    break;
                case 'register':
                    html = renderRegisterForm();
                    break;
                case 'privacy':
                    html = await renderPrivacyPolicy();
                    break;
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'order':
                    html = renderOrderPage();
                    break;
                case 'balance':
                    html = renderBalancePage();
                    break;
                case 'home':
                default:
                    html = renderHome();
                    break;
            }
            contentElement.innerHTML = html;
            lucide.createIcons(); // Re-render icons after view change
        };

        /** Auth butonlarını kullanıcı durumuna göre günceller */
        const updateAuthButtons = () => {
            authButtonsElement.innerHTML = '';
            if (currentUser) {
                // Logged in
                authButtonsElement.innerHTML = `
                    <span class="text-sm font-semibold text-green-400 hidden md:block">${formatBalance(userBalance)} ₺</span>
                    <button onclick="changeView('dashboard')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition duration-150 shadow-md flex items-center">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> Panel
                    </button>
                    <button onclick="handleLogout()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-2 px-3 rounded-full transition duration-150 text-sm shadow-md">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                `;
            } else {
                // Logged out
                authButtonsElement.innerHTML = `
                    <button onclick="changeView('login')" class="bg-transparent text-indigo-400 hover:text-indigo-300 font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm border border-indigo-400 hover:border-indigo-300 hover-lift">
                        Giriş Yap
                    </button>
                    <button onclick="changeView('register')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm hover-lift">
                        Kayıt Ol
                    </button>
                `;
            }
            lucide.createIcons();
        };

        // =================================================================
        // 4. İÇERİK ŞABLONLARI (TURKCE)
        // =================================================================

        const renderHome = () => `
            <div class="max-w-4xl mx-auto text-center py-16 sm:py-24">
                <h1 class="text-5xl sm:text-7xl font-extrabold text-white leading-tight">
                    Sosyal Medya Başarınız İçin <span class="text-indigo-500">VIP Çözümler</span>
                </h1>
                <p class="mt-6 text-xl text-gray-400 max-w-2xl mx-auto">
                    Hesabınızı hızla büyütün. En kaliteli hizmetler, en uygun fiyatlarla burada. Instagram, Twitter, TikTok ve daha fazlası.
                </p>
                <div class="mt-10 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                    <button onclick="changeView('register')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-xl transition duration-300 transform hover:scale-105">
                        Şimdi Kayıt Ol
                    </button>
                    <button onclick="changeView('login')" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 px-8 rounded-xl shadow-xl transition duration-300 transform hover:scale-105">
                        Giriş Yap
                    </button>
                </div>

                <div class="mt-20 grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                    <div class="card-bg p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500 hover-lift">
                        <i data-lucide="zap" class="w-8 h-8 text-indigo-400 mb-3"></i>
                        <h3 class="text-2xl font-semibold mb-3 text-white">Hızlı Teslimat</h3>
                        <p class="text-gray-400">Siparişleriniz anında işlenir ve en kısa sürede hedefinize ulaşır. Beklemeye son!</p>
                    </div>
                    <div class="card-bg p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500 hover-lift">
                        <i data-lucide="headphones" class="w-8 h-8 text-indigo-400 mb-3"></i>
                        <h3 class="text-2xl font-semibold mb-3 text-white">7/24 Destek</h3>
                        <p class="text-gray-400">Yaşadığınız her sorunda size yardımcı olmak için hazırız. Güvenli alışveriş garantisi.</p>
                    </div>
                    <div class="card-bg p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500 hover-lift">
                        <i data-lucide="wallet" class="w-8 h-8 text-indigo-400 mb-3"></i>
                        <h3 class="text-2xl font-semibold mb-3 text-white">Uygun Fiyatlar</h3>
                        <p class="text-gray-400">Piyasadaki en rekabetçi fiyatlarla, bütçenizi zorlamadan büyüyün.</p>
                    </div>
                </div>
            </div>
        `;

        const renderAuthCard = (title, formHtml, linkText, linkAction) => `
            <div class="w-full max-w-md mt-10">
                <div class="card-bg p-8 sm:p-10 rounded-xl shadow-2xl border-t-4 border-indigo-500">
                    <h2 class="text-3xl font-bold text-center text-white mb-8">${title}</h2>
                    ${formHtml}
                    <p class="mt-6 text-center text-gray-400 text-sm">
                        ${linkText} 
                        <a href="#" onclick="changeView('${linkAction}'); return false;" class="text-indigo-400 hover:text-indigo-300 font-medium">Buraya Tıkla</a>
                    </p>
                </div>
            </div>
        `;

        const renderLoginForm = () => renderAuthCard(
            "Giriş Yap",
            `
            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="mb-5">
                    <label for="login-email" class="block text-sm font-medium text-gray-400 mb-2">E-posta</label>
                    <input type="email" id="login-email" placeholder="email@ornek.com" required 
                        class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-indigo-500" autocomplete="email">
                </div>
                <div class="mb-8">
                    <label for="login-password" class="block text-sm font-medium text-gray-400 mb-2">Şifre</label>
                    <input type="password" id="login-password" placeholder="Şifreniz" required 
                        class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-indigo-500" autocomplete="current-password">
                </div>
                <button type="submit" id="login-button" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-lg transform hover:scale-[1.01]">
                    Giriş Yap
                </button>
            </form>
            `,
            "Hesabınız yok mu?", "register"
        );

        const renderRegisterForm = () => renderAuthCard(
            "Yeni Hesap Oluştur",
            `
            <form id="register-form" onsubmit="event.preventDefault(); handleRegister();">
                <div class="mb-5">
                    <label for="register-email" class="block text-sm font-medium text-gray-400 mb-2">E-posta</label>
                    <input type="email" id="register-email" placeholder="email@ornek.com" required 
                        class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-indigo-500" autocomplete="email">
                </div>
                <div class="mb-5">
                    <label for="register-password" class="block text-sm font-medium text-gray-400 mb-2">Şifre (Min 6 Karakter)</label>
                    <input type="password" id="register-password" placeholder="Güçlü bir şifre" required minlength="6"
                        class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-indigo-500" autocomplete="new-password">
                </div>
                <div class="mb-8 flex items-start">
                    <input type="checkbox" id="register-terms" required class="h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 rounded mt-1 focus:ring-indigo-500">
                    <label for="register-terms" class="ml-2 text-sm text-gray-400">
                        <a href="#" onclick="changeView('privacy'); return false;" class="text-indigo-400 hover:text-indigo-300 font-medium">Gizlilik Politikası</a>'nı okudum ve kabul ediyorum.
                    </label>
                </div>
                <button type="submit" id="register-button" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-lg transform hover:scale-[1.01]">
                    Kayıt Ol
                </button>
            </form>
            `,
            "Zaten hesabınız var mı?", "login"
        );

        const renderDashboard = () => {
            if (!currentUser) return `<p class="text-center text-red-400 mt-10">Lütfen giriş yapın.</p>`;

            const formattedBalance = formatBalance(userBalance);

            // Order Table Rows
            const orderRows = orders.length > 0 ? orders
                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)) // Sort by date desc
                .slice(0, 10) // Show only latest 10 orders
                .map(order => {
                    let statusClass = 'bg-gray-500';
                    if (order.status === 'Tamamlandı') statusClass = 'bg-green-600';
                    else if (order.status === 'Beklemede') statusClass = 'bg-yellow-500 text-gray-900';
                    else if (order.status === 'İşleniyor') statusClass = 'bg-blue-600';

                    const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString('tr-TR') : 'N/A';
                    
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-700 transition">
                            <td class="px-4 py-3 text-xs md:text-sm">${order.id.substring(0, 6)}...</td>
                            <td class="px-4 py-3 text-sm font-medium">${order.serviceName}</td>
                            <td class="px-4 py-3 text-sm">${order.quantity.toLocaleString('tr-TR')}</td>
                            <td class="px-4 py-3 text-sm font-bold text-red-400">${order.cost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ₺</td>
                            <td class="px-4 py-3">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full text-white ${statusClass}">
                                    ${order.status}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-500">${date}</td>
                        </tr>
                    `;
                }).join('') : `
                <tr>
                    <td colspan="6" class="px-6 py-6 text-center text-gray-500">Henüz bir siparişiniz bulunmamaktadır.</td>
                </tr>
            `;

            return `
                <div class="w-full max-w-7xl mt-10">
                    <div class="card-bg p-8 rounded-xl shadow-2xl border-t-4 border-indigo-500">
                        <h2 class="text-3xl font-bold text-white mb-8 border-b border-gray-700 pb-4 flex items-center">
                            <i data-lucide="layout-dashboard" class="w-6 h-6 mr-3 text-indigo-400"></i> Kullanıcı Paneli
                        </h2>
                        
                        <!-- Bakiye & Hızlı Erişim Kartları -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                            <!-- Bakiye Kartı -->
                            <div class="bg-gray-700 p-5 rounded-xl shadow-lg border-l-4 border-green-500 flex flex-col justify-between hover-lift">
                                <i data-lucide="wallet" class="w-6 h-6 text-green-400"></i>
                                <p class="text-green-400 text-sm font-medium mt-2">Güncel Bakiyeniz</p>
                                <p class="text-3xl font-extrabold mt-1 text-white">${formattedBalance} ₺</p>
                            </div>
                            
                            <!-- Bakiye Yükle Butonu -->
                            <button onclick="changeView('balance')" class="bg-green-600 hover:bg-green-700 p-5 rounded-xl shadow-lg transition duration-300 flex flex-col items-center justify-center transform hover:scale-[1.02] text-center font-semibold">
                                <i data-lucide="plus-circle" class="w-6 h-6 mb-1"></i>
                                <span class="text-white text-lg">Bakiye Yükle</span>
                            </button>
                            
                            <!-- Yeni Sipariş Butonu -->
                            <button onclick="changeView('order')" class="bg-purple-600 hover:bg-purple-700 p-5 rounded-xl shadow-lg transition duration-300 flex flex-col items-center justify-center transform hover:scale-[1.02] text-center font-semibold">
                                <i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i>
                                <span class="text-white text-lg">Yeni Sipariş</span>
                            </button>
                            
                            <!-- Toplam Sipariş Kartı -->
                            <div class="bg-gray-700 p-5 rounded-xl shadow-lg border-l-4 border-yellow-500 flex flex-col justify-between hover-lift">
                                <i data-lucide="clipboard-list" class="w-6 h-6 text-yellow-400"></i>
                                <p class="text-yellow-400 text-sm font-medium mt-2">Toplam Sipariş</p>
                                <p class="text-3xl font-extrabold mt-1 text-white">${orders.length}</p>
                            </div>
                        </div>
                        
                        <!-- Kullanıcı Bilgisi -->
                        <div class="bg-gray-900 p-4 rounded-lg mb-8 text-sm text-gray-400 break-all border border-gray-700">
                            <span class="font-medium text-white">Kullanıcı ID:</span> ${currentUser.uid}
                        </div>

                        <!-- Sipariş Geçmişi -->
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center">
                            <i data-lucide="history" class="w-5 h-5 mr-2 text-indigo-400"></i> Son 10 Sipariş Geçmişi
                        </h3>
                        <div class="overflow-x-auto card-bg rounded-xl shadow-inner border border-gray-700">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Hizmet</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Miktar</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Maliyet</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Durum</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Tarih</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${orderRows}
                                </tbody>
                            </table>
                        </div>

                        <button onclick="handleLogout()" class="mt-8 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                            <i data-lucide="log-out" class="w-4 h-4 mr-1"></i> Güvenli Çıkış
                        </button>
                    </div>
                </div>
            `;
        };

        const renderOrderPage = () => {
            if (!currentUser) return `<p class="text-center text-red-400 mt-10">Lütfen sipariş vermek için giriş yapın.</p>`;
            
            const formattedBalance = formatBalance(userBalance);
            
            return `
                <div class="w-full max-w-2xl mt-10">
                    <div class="card-bg p-8 rounded-xl shadow-2xl border-t-4 border-purple-500">
                        <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-4 flex items-center">
                            <i data-lucide="shopping-cart" class="w-6 h-6 mr-2 text-purple-400"></i> Yeni Sipariş Oluştur
                        </h2>
                        
                        <div class="bg-gray-900 p-4 rounded-lg mb-6 flex justify-between items-center border border-gray-700 shadow-inner">
                            <p class="text-purple-400 font-medium flex items-center"><i data-lucide="coins" class="w-4 h-4 mr-2"></i> Güncel Bakiyeniz:</p>
                            <p class="text-2xl font-bold text-white">${formattedBalance} ₺</p>
                        </div>

                        <form id="order-form" onsubmit="event.preventDefault(); handleOrderPlacement();">
                            
                            <div class="mb-5">
                                <label for="service-select" class="block text-sm font-medium text-gray-400 mb-2">Hizmet Seçimi</label>
                                <select id="service-select" required onchange="updateOrderDetails()"
                                    class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-purple-500 appearance-none">
                                    <option value="">-- Hizmet Seçiniz --</option>
                                    ${SERVICES.map(s => `<option value="${s.id}" data-price="${s.pricePerK}" data-min="${s.min}" data-max="${s.max}">${s.name} (${s.pricePerK.toFixed(2)} ₺ / 1K)</option>`).join('')}
                                </select>
                            </div>

                            <div class="mb-5">
                                <label for="order-link" class="block text-sm font-medium text-gray-400 mb-2">Hedef Link / Kullanıcı Adı</label>
                                <input type="url" id="order-link" placeholder="https://instagram.com/p/..." required 
                                    class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>

                            <div class="mb-5">
                                <label for="order-quantity" class="block text-sm font-medium text-gray-400 mb-2">Miktar</label>
                                <input type="number" id="order-quantity" placeholder="Min/Max miktar" required min="1" step="1" oninput="updateOrderDetails()"
                                    class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <p id="min-max-info" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                            
                            <div class="bg-gray-900 p-4 rounded-lg mb-8 border border-gray-700 shadow-lg">
                                <p class="flex justify-between text-xl font-bold text-white">
                                    Tahmini Maliyet: <span id="total-cost" class="text-purple-400">0.00 ₺</span>
                                </p>
                            </div>

                            <button type="submit" id="order-button" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-xl transform hover:scale-[1.01]">
                                Siparişi Onayla ve Ver
                            </button>
                        </form>

                        <button onclick="changeView('dashboard')" class="mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                            Panele Geri Dön
                        </button>
                    </div>
                </div>
                <script>
                    // Updates Quantity and Cost Calculation
                    window.updateOrderDetails = () => {
                        const select = document.getElementById('service-select');
                        const quantityInput = document.getElementById('order-quantity');
                        const minMaxInfo = document.getElementById('min-max-info');
                        const costSpan = document.getElementById('total-cost');
                        const orderButton = document.getElementById('order-button');
                        
                        const selectedOption = select.options[select.selectedIndex];
                        const quantity = parseInt(quantityInput.value) || 0;
                        
                        let cost = 0;
                        let isValid = true;
                        
                        if (selectedOption.value) {
                            const pricePerK = parseFloat(selectedOption.getAttribute('data-price'));
                            const min = parseInt(selectedOption.getAttribute('data-min'));
                            const max = parseInt(selectedOption.getAttribute('data-max'));
                            
                            minMaxInfo.textContent = \`Min: \${min.toLocaleString('tr-TR')}, Max: \${max.toLocaleString('tr-TR')}\`;

                            if (quantity < min || quantity > max || quantity === 0) {
                                minMaxInfo.className = 'text-xs mt-1 text-red-400';
                                isValid = false;
                            } else {
                                minMaxInfo.className = 'text-xs mt-1 text-green-400';
                                // Cost Calculation: (Quantity / 1000) * Price Per 1K
                                cost = (quantity / 1000) * pricePerK;
                            }

                        } else {
                            minMaxInfo.textContent = 'Hizmet seçimi yapınız.';
                            minMaxInfo.className = 'text-xs mt-1 text-gray-500';
                        }
                        
                        costSpan.textContent = cost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ₺';
                        
                        // Check for balance and validity
                        if (cost > userBalance) {
                            costSpan.classList.add('text-red-400');
                            costSpan.classList.remove('text-purple-400');
                            orderButton.disabled = true;
                            orderButton.textContent = 'Yetersiz Bakiye!';
                        } else if (!isValid || quantity === 0 || cost === 0) {
                            costSpan.classList.remove('text-red-400');
                            costSpan.classList.add('text-purple-400');
                            orderButton.disabled = true;
                            orderButton.textContent = 'Siparişi Onayla ve Ver';
                        } else {
                            costSpan.classList.remove('text-red-400');
                            costSpan.classList.add('text-purple-400');
                            orderButton.disabled = false;
                            orderButton.textContent = 'Siparişi Onayla ve Ver';
                        }
                    };
                    
                    // Call once after rendering
                    setTimeout(window.updateOrderDetails, 0); 
                </script>
            `;
        };

        const renderBalancePage = () => {
            if (!currentUser) return `<p class="text-center text-red-400 mt-10">Lütfen bakiye yüklemek için giriş yapın.</p>`;
            
            const formattedBalance = formatBalance(userBalance);

            return `
                <div class="w-full max-w-md mt-10">
                    <div class="card-bg p-8 rounded-xl shadow-2xl border-t-4 border-green-500">
                        <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-4 flex items-center">
                            <i data-lucide="dollar-sign" class="w-6 h-6 mr-2 text-green-400"></i> Bakiye Yükle
                        </h2>

                        <div class="bg-gray-900 p-4 rounded-lg mb-6 flex justify-between items-center border border-gray-700 shadow-inner">
                            <p class="text-green-400 font-medium flex items-center"><i data-lucide="coins" class="w-4 h-4 mr-2"></i> Güncel Bakiyeniz:</p>
                            <p class="text-2xl font-bold text-white">${formattedBalance} ₺</p>
                        </div>
                        
                        <p class="text-gray-400 mb-6 text-sm italic p-3 bg-gray-900 rounded-lg border border-red-500/50">
                            <strong class="text-red-400">DİKKAT:</strong> Bu, gerçek bir ödeme sistemi değildir. İşlem, bakiyenizin kalıcı olarak artırılması için simüle edilmiştir.
                        </p>

                        <form id="deposit-form" onsubmit="event.preventDefault(); handleDeposit();">
                            
                            <div class="mb-5">
                                <label for="deposit-amount" class="block text-sm font-medium text-gray-400 mb-2">Yüklenecek Miktar (₺) - Min 10.00</label>
                                <input type="number" id="deposit-amount" placeholder="Örn: 50.00" required min="10" step="0.01"
                                    class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <div class="mb-8">
                                <label for="deposit-method" class="block text-sm font-medium text-gray-400 mb-2">Ödeme Yöntemi (Seçim)</label>
                                <select id="deposit-method" required 
                                    class="input-field w-full p-3 rounded-lg focus:ring-2 focus:ring-green-500 appearance-none">
                                    <option value="kredi">Kredi Kartı / Banka Kartı</option>
                                    <option value="eft">EFT / Havale</option>
                                    <option value="kripto">Kripto Para</option>
                                </select>
                            </div>

                            <button type="submit" id="deposit-button" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-xl transform hover:scale-[1.01]">
                                Bakiyeyi Yükle
                            </button>
                        </form>
                        <button onclick="changeView('dashboard')" class="mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                            Panele Geri Dön
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- Privacy Policy (Remains similar, updated style) ---
        const renderPrivacyPolicy = async () => {
            const privacyDocRef = getPublicDocRef('settings', 'privacy_policy');
            let policyContent = 'Gizlilik politikası içeriği yükleniyor...';

            try {
                const docSnap = await getDoc(privacyDocRef);

                if (docSnap.exists()) {
                    policyContent = docSnap.data().content || 'Gizlilik politikası içeriği mevcut değil.';
                } else {
                    const defaultPolicy = {
                        content: `
                            <p class="mb-4 text-white"><strong>1. Giriş</strong></p>
                            <p class="mb-6">VIP SMM Panel, kullanıcı gizliliğini ciddiye alır. Bu Gizlilik Politikası, hizmetimizi kullandığınızda kişisel verilerinizi nasıl topladığımızı, kullandığımızı, sakladığımızı ve koruduğumuzu açıklamaktadır.</p>
                            
                            <p class="mb-4 text-white"><strong>2. Toplanan Bilgiler</strong></p>
                            <ul class="list-disc list-inside ml-4 mb-6 space-y-2">
                                <li><strong>Kimlik Bilgileri:</strong> Kayıt olurken sağladığınız E-posta adresi ve şifre.</li>
                                <li><strong>İşlem Bilgileri:</strong> Verdiğiniz siparişler, kullanılan hizmetler, bakiye yükleme kayıtları. (Ödeme bilgileri sunucularımızda saklanmaz.)</li>
                            </ul>
                            
                            <p class="mb-4 text-white"><strong>3. Verilerin Kullanımı</strong></p>
                            <p class="mb-6">Topladığımız veriler, size hizmet sunmak, hesabınızı yönetmek, siparişlerinizi işlemek ve hizmet kalitemizi artırmak için kullanılır.</p>
                            
                            <p class="mb-4 text-white"><strong>4. Veri Güvenliği</strong></p>
                            <p class="mb-6">Verilerinizin güvenliğini sağlamak için endüstri standardı güvenlik önlemleri (SSL şifreleme ve Firebase güvenliği dahil) kullanmaktayız.</p>
                            
                            <p class="mb-4 text-white"><strong>5. İletişim</strong></p>
                            <p>Gizlilik politikamız hakkında sorularınız varsa, lütfen bizimle iletişime geçin.</p>
                        `,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await setDoc(privacyDocRef, defaultPolicy);
                    policyContent = defaultPolicy.content;
                }
            } catch (error) {
                console.error("Firestore Gizlilik Politikası hatası:", error);
                policyContent = '<p class="text-red-400">Gizlilik politikası yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.</p>';
            }

            return `
                <div class="w-full max-w-4xl mt-10">
                    <div class="card-bg p-8 rounded-xl shadow-2xl border-t-4 border-indigo-500">
                        <h2 class="text-3xl font-bold text-white mb-6 flex items-center"><i data-lucide="shield" class="w-6 h-6 mr-2 text-indigo-400"></i> Gizlilik Politikası</h2>
                        <div class="text-gray-400 leading-relaxed space-y-4">
                            ${policyContent}
                        </div>
                        <button onclick="changeView('home')" class="mt-8 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Anasayfaya Dön
                        </button>
                    </div>
                </div>
            `;
        };

        // =================================================================
        // 5. AUTHENTICATION (KİMLİK DOĞRULAMA) İŞLEVLERİ
        // =================================================================

        /** Kullanıcı Girişi */
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const button = document.getElementById('login-button');

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-1 inline-block"></i> Giriş Yapılıyor...';
            lucide.createIcons();

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Başarılı!', 'Giriş başarılı. Panel sayfasına yönlendiriliyorsunuz.');
            } catch (error) {
                let errorMessage = 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.';
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Geçersiz e-posta adresi.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kullanıcı bulunamadı veya şifre yanlış.';
                }
                showMessage('Hata', errorMessage, true);
                console.error("Login Error:", error);
            } finally {
                button.disabled = false;
                button.textContent = 'Giriş Yap';
            }
        };

        /** Yeni Kullanıcı Kaydı */
        window.handleRegister = async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const terms = document.getElementById('register-terms').checked;
            const button = document.getElementById('register-button');

            if (!terms) {
                showMessage('Uyarı', 'Kayıt olmak için Gizlilik Politikası\'nı kabul etmelisiniz.', true);
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-1 inline-block"></i> Kayıt Olunuyor...';
            lucide.createIcons();

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Profile creation is handled in onAuthStateChanged
                showMessage('Tebrikler!', `Kayıt başarılı. Hoş geldiniz, ${userCredential.user.email}!`);
            } catch (error) {
                let errorMessage = 'Kayıt başarısız. Lütfen bilgileri kontrol edin.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Bu e-posta adresi zaten kullanımda.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Şifre en az 6 karakter olmalıdır.';
                }
                showMessage('Hata', errorMessage, true);
                console.error("Register Error:", error);
            } finally {
                button.disabled = false;
                button.textContent = 'Kayıt Ol';
            }
        };

        /** Çıkış Yapma */
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showMessage('Güle Güle!', 'Başarıyla çıkış yapıldı.');
            } catch (error) {
                showMessage('Hata', 'Çıkış yapılırken bir sorun oluştu.', true);
                console.error("Logout Error:", error);
            }
        };


        // =================================================================
        // 6. BAKİYE VE SİPARİŞ İŞLEVLERİ (GERÇEK VERİ İÇİN)
        // =================================================================

        /** Bakiye Ekleme İşlemi (Firestore Transaction ile) */
        window.handleDeposit = async () => {
            if (!currentUser) {
                showMessage('Hata', 'Bakiye yüklemek için giriş yapmalısınız.', true);
                return;
            }

            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const method = document.getElementById('deposit-method').value;
            const button = document.getElementById('deposit-button');

            if (isNaN(amount) || amount < 10) {
                showMessage('Hata', 'Lütfen geçerli bir miktar girin (Minimum 10.00 ₺).', true);
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-1 inline-block"></i> İşleniyor...';
            lucide.createIcons();

            try {
                await runTransaction(db, async (transaction) => {
                    const userId = currentUser.uid;
                    const profileRef = getUserProfileRef(userId);
                    const profileSnap = await transaction.get(profileRef);

                    if (!profileSnap.exists()) {
                         throw "Kullanıcı profili bulunamadı. Lütfen tekrar deneyin.";
                    }
                    
                    const currentBalance = profileSnap.data().balance || 0.00;
                    // Fix: Ensure newBalance calculation is robust against floating point issues (toFixed(2))
                    const newBalance = parseFloat((currentBalance + amount).toFixed(2));
                    
                    // Update the new balance
                    transaction.update(profileRef, {
                        balance: newBalance,
                        lastDeposit: serverTimestamp()
                    });
                });

                showMessage('Bakiye Başarılı!', `${amount.toFixed(2)} ₺ bakiyeniz başarıyla yüklendi (${method} ile simüle edildi).`);

            } catch (error) {
                let errorMessage = 'Bakiye yüklenirken bir hata oluştu.';
                if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    console.error("Deposit Error:", error);
                }
                showMessage('Hata', errorMessage, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Bakiyeyi Yükle';
            }
        };
        
        /** Sipariş Verme İşlemi (Firestore Transaction ile) */
        window.handleOrderPlacement = async () => {
            if (!currentUser) {
                showMessage('Hata', 'Sipariş vermek için giriş yapmalısınız.', true);
                return;
            }

            const select = document.getElementById('service-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                showMessage('Hata', 'Lütfen bir hizmet seçimi yapın.', true);
                return;
            }

            const serviceId = parseInt(selectedOption.value);
            const serviceName = selectedOption.textContent.split('(')[0].trim();
            
            const link = document.getElementById('order-link').value;
            const quantity = parseInt(document.getElementById('order-quantity').value);
            
            const pricePerK = parseFloat(selectedOption.getAttribute('data-price'));
            // Fix: Calculate cost using toFixed(2) to ensure correct precision
            const cost = parseFloat(((quantity / 1000) * pricePerK).toFixed(2));

            if (cost === 0 || cost > userBalance) {
                showMessage('Hata', 'Geçersiz miktar veya yetersiz bakiye. Lütfen bakiyenizi kontrol edin.', true);
                return;
            }

            // Check min/max again for safety (UI validation might be bypassed)
            const min = parseInt(selectedOption.getAttribute('data-min'));
            const max = parseInt(selectedOption.getAttribute('data-max'));
            if (quantity < min || quantity > max || isNaN(quantity)) {
                showMessage('Hata', `Sipariş miktarı ${min} ile ${max} arasında olmalıdır.`, true);
                return;
            }

            const orderButton = document.getElementById('order-button');
            orderButton.disabled = true;
            orderButton.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-1 inline-block"></i> Sipariş Veriliyor...';
            lucide.createIcons();

            try {
                await runTransaction(db, async (transaction) => {
                    const userId = currentUser.uid;
                    const profileRef = getUserProfileRef(userId);
                    const profileSnap = await transaction.get(profileRef);

                    if (!profileSnap.exists()) {
                        throw "Kullanıcı profili bulunamadı.";
                    }

                    const currentBalance = profileSnap.data().balance || 0.00;
                    // Fix: Ensure newBalance calculation is robust against floating point issues (toFixed(2))
                    const newBalance = parseFloat((currentBalance - cost).toFixed(2));

                    if (newBalance < 0) {
                        throw "Yetersiz Bakiye! İşlem iptal edildi. Lütfen bakiyenizi kontrol edin.";
                    }

                    // 1. Update new balance (Transaction ensures atomic update)
                    transaction.update(profileRef, { balance: newBalance });

                    // 2. Add new order
                    const newOrderRef = doc(getOrdersCollectionRef(userId)); // Auto-ID
                    transaction.set(newOrderRef, {
                        serviceId: serviceId,
                        serviceName: serviceName,
                        link: link,
                        quantity: quantity,
                        cost: cost,
                        status: 'Beklemede', // Initial status
                        createdAt: serverTimestamp()
                    });
                });

                showMessage('Sipariş Başarılı!', `Toplam ${cost.toFixed(2)} ₺ karşılığında siparişiniz alındı. Bakiyeniz güncellendi.`);
                changeView('dashboard'); // Redirect to dashboard after successful order

            } catch (error) {
                let errorMessage = 'Sipariş verilirken bir hata oluştu.';
                if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    console.error("Order Placement Error:", error);
                }
                showMessage('Hata', errorMessage, true);
            } finally {
                orderButton.disabled = false;
                orderButton.textContent = 'Siparişi Onayla ve Ver';
            }
        };


        // =================================================================
        // 7. INITIALIZATION AND AUTH STATE LISTENING
        // =================================================================

        /** Listens for authentication state changes */
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthButtons();

            // Clean up previous listeners
            if (unsubscribeBalance) { unsubscribeBalance(); unsubscribeBalance = null; }
            if (unsubscribeOrders) { unsubscribeOrders(); unsubscribeOrders = null; }
            userBalance = 0.00; 
            orders = []; 

            if (user) {
                // User logged in, start listening for profile and orders.
                const profileRef = getUserProfileRef(user.uid);
                
                // 1. Profile and Balance Listener (Real-time balance)
                unsubscribeBalance = onSnapshot(profileRef, (docSnap) => {
                    let balanceUpdated = false;
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (userBalance !== data.balance) {
                            userBalance = data.balance || 0.00;
                            balanceUpdated = true;
                        }
                    } else {
                        // If profile doesn't exist (new registration), create it
                        setDoc(profileRef, {
                            email: user.email,
                            balance: 0.00,
                            createdAt: serverTimestamp()
                        }).catch(e => console.error("User profile creation error:", e));
                        userBalance = 0.00;
                        balanceUpdated = true;
                    }
                    
                    // Update UI only if the balance actually changed or if initial state load
                    if (balanceUpdated || !isAuthReady) {
                        updateAuthButtons(); // Update balance display in header
                        if (currentView === 'dashboard' || currentView === 'order' || currentView === 'balance') {
                            changeView(currentView); // Re-render the main content area
                        }
                    }
                }, (error) => {
                    console.error("Balance Listener Error:", error);
                });

                // 2. Orders Listener (Real-time orders list)
                const ordersColRef = getOrdersCollectionRef(user.uid);
                unsubscribeOrders = onSnapshot(ordersColRef, (snapshot) => {
                    const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Check if orders list actually changed (simple length check for performance)
                    if (newOrders.length !== orders.length || JSON.stringify(newOrders) !== JSON.stringify(orders)) {
                        orders = newOrders;
                        // Update dashboard if orders list changed
                        if (currentView === 'dashboard') {
                            changeView('dashboard');
                        }
                    }
                }, (error) => {
                    console.error("Orders Listener Error:", error);
                });
            }

            // Handle initial view setting based on auth status
            if (isAuthReady) {
                if (user) {
                    if (currentView === 'login' || currentView === 'register' || currentView === 'home') {
                        changeView('dashboard');
                    }
                } else {
                    if (currentView === 'dashboard' || currentView === 'order' || currentView === 'balance') {
                        changeView('home');
                    }
                }
            } else {
                 // Initial load completed, render current view
                changeView(currentView);
                isAuthReady = true;
            }
        }); // Hata düzeltmesi için noktalı virgül eklendi.

        /** Initial Authentication on Window Load */
        window.onload = async () => {
            // Wait for lucide icons to be created (called via onload attribute on <body>)
            // Then attempt to sign in using the provided token or anonymously
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with Canvas token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                // Fallback to home view if auth fails completely
                changeView('home');
                isAuthReady = true; 
            }
        };

    </script>
</body>
</html>
